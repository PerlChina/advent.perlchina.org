<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
   "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<!-- Generated by Pod::Advent 0.21 (Pod::Simple 3.13, Perl::Tidy 20090616) on 2010-12-13 06:04:10 -->
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<title>2010 Perl Advent Calendar: JE</title>
<meta http-equiv="content-type" content="text/html; charset=utf-8" />
<link rel="stylesheet" href="../style.css" type="text/css" />
<link rel="alternate" type="text/plain" href="JE.pod" />
</head>
<body>
<h1><a href="../">Perl Advent Calendar 2010-12</a>-13</h1>
<h2 align="center">JE</h2>
<h3 align="center">by Fayland Lam</h3>
<p>JavaScript 是个很不错的语言。网上有一个简单的叫 ROT 13 的加密来保护 email，今天我们做一点邪恶的事，就是简单破解该加密。</p>
<p>ROT 13 的版本有很多，不过原理是一样的。下面是一个简单的例子。</p>
<p>php 有内置的 str_rot13，Perl 我们需要安装 <tt><a href="http://search.cpan.org/perldoc?Crypt::Rot13">Crypt::Rot13</a></tt></p>
<pre>
<span class="k">use</span> <span class="w">Crypt::Rot13</span><span class="sc">;</span>

<span class="k">my</span> <span class="i">$rot13</span> = <span class="w">new</span> <span class="w">Crypt::Rot13</span><span class="sc">;</span>
<span class="i">$rot13</span><span class="i">-&gt;charge</span><span class="s">(</span><span class="q">&#39;&lt;a href=&quot;mailto:test@example.com&quot;&gt;test&lt;/a&gt;&#39;</span><span class="s">)</span><span class="sc">;</span>
<span class="k">print</span> <span class="i">$rot13</span><span class="i">-&gt;rot13</span><span class="s">(</span><span class="s">)</span> . <span class="q">&quot;\n&quot;</span><span class="sc">;</span>
</pre>

<p>然后我们把它放到 html 里。</p>
<pre>
<span class="q">&lt;script type=&quot;text/javascript&quot;&gt;</span>
<span class="w">Rot13</span> = <span class="s">{</span>
    <span class="k">map</span><span class="co">:</span> <span class="w">null</span><span class="cm">,</span>

    <span class="w">convert</span><span class="co">:</span> <span class="i">function</span><span class="s">(</span><span class="w">a</span><span class="s">)</span> <span class="s">{</span>
        <span class="w">Rot13</span>.<span class="i">init</span><span class="s">(</span><span class="s">)</span><span class="sc">;</span>

        <span class="w">var</span> <span class="q">s = &quot;&quot;;</span>
        <span class="q">        for (i=0; i &lt; a.length; i++) {</span>
            <span class="q">            var b =</span> <span class="w">a</span>.<span class="i">charAt</span><span class="s">(</span><span class="w">i</span><span class="s">)</span><span class="sc">;</span>
            <span class="q">s += ((b&gt;=&#39;A&#39; &amp;&amp; b&lt;=&#39;Z&#39;) || (b&gt;=&#39;a&#39; &amp;&amp; b&lt;=&#39;z&#39;) ? Rot13.map[b] : b);</span>
        <span class="q">        }</span>
        <span class="q">        return s;</span>
    <span class="q">    },</span>

    <span class="q">    init: function() {</span>
        <span class="q">        if (Rot13.map != null)</span>
            <span class="q">            return;</span>
                            
        <span class="q">        var map = new Array();</span>
        <span class="q">        var s   = &quot;abcdefghijklmnopqrstuvwxyz&quot;;</span>

        <span class="q">        for (i=0; i&lt;s.length; i++</span><span class="p">)</span>
            <span class="k">map</span><span class="s">[</span><span class="q">s.charAt(i)] = s.charAt((i+13)%26);</span>
        <span class="q">        for (i=0; i&lt;s.</span><span class="k">length</span><span class="sc">;</span> <span class="w">i</span>++<span class="p">)</span>
            <span class="k">map</span><span class="s">[</span><span class="q">s.charAt(i).toUpperCase()] = s.charAt</span><span class="s">(</span><span class="s">(</span><span class="w">i</span>+<span class="n">13</span><span class="s">)</span>%<span class="n">26</span><span class="s">)</span>.<span class="i">toUpperCase</span><span class="s">(</span><span class="s">)</span><span class="sc">;</span>

        <span class="w">Rot13</span>.<span class="k">map</span> = <span class="k">map</span><span class="sc">;</span>
    <span class="s">}</span><span class="cm">,</span>

    <span class="k">write</span><span class="co">:</span> <span class="i">function</span><span class="s">(</span><span class="w">a</span><span class="s">)</span> <span class="s">{</span>
        <span class="w">document</span>.<span class="k">write</span><span class="s">(</span><span class="w">Rot13</span>.<span class="i">convert</span><span class="s">(</span><span class="w">a</span><span class="s">)</span><span class="s">)</span><span class="sc">;</span>
    <span class="s">}</span>
<span class="s">}</span>


<span class="w">Rot13</span>.<span class="k">write</span><span class="s">(</span><span class="q">&#39;&lt;n uers=&quot;znvygb:grfg@rknzcyr.pbz&quot;&gt;grfg&lt;/n&gt;&#39;</span><span class="s">)</span><span class="sc">;</span>

<span class="q">&lt;/script&gt;</span>
</pre>

<p>你会简单的发现，html 里显示的是跟 &lt;a href="mailto:test@example.com">test&lt;/a> 一样的东西，但是从源代码来看是加密过的。</p>
<p>上面只是一个很简单的例子。很多网页上可能不是 ROT 13 加密，但是我们无需理会，强大的 <tt><a href="http://search.cpan.org/perldoc?JE">JE</a></tt> 会解决一切。</p>
<p>JE 是由 Perl 编写的 ECMAScript 引擎。虽然非 100% 兼容，但是大部分情况下都是很好用的。</p>
<pre>
<span class="k">use</span> <span class="w">JE</span><span class="sc">;</span>

<span class="k">my</span> <span class="i">$j</span> = <span class="w">JE</span><span class="w">-&gt;new</span><span class="sc">;</span>
<span class="k">my</span> <span class="i">$v</span> = <span class="i">$j</span><span class="i">-&gt;eval</span><span class="s">(</span><span class="h">&lt;&lt;&#39;JS&#39;</span><span class="s">)</span><span class="sc">;</span>
<span class="hh">Rot13 = {</span>
<span class="hh">    map: null,</span>

<span class="hh">    convert: function(a) {</span>
<span class="hh">        Rot13.init();</span>

<span class="hh">        var s = &quot;&quot;;</span>
<span class="hh">        for (i=0; i &lt; a.length; i++) {</span>
<span class="hh">            var b = a.charAt(i);</span>
<span class="hh">            s += ((b&gt;=&#39;A&#39; &amp;&amp; b&lt;=&#39;Z&#39;) || (b&gt;=&#39;a&#39; &amp;&amp; b&lt;=&#39;z&#39;) ? Rot13.map[b] : b);</span>
<span class="hh">        }</span>
<span class="hh">        return s;</span>
<span class="hh">    },</span>

<span class="hh">    init: function() {</span>
<span class="hh">        if (Rot13.map != null)</span>
<span class="hh">            return;</span>
              
<span class="hh">        var map = new Array();</span>
<span class="hh">        var s   = &quot;abcdefghijklmnopqrstuvwxyz&quot;;</span>

<span class="hh">        for (i=0; i&lt;s.length; i++)</span>
<span class="hh">            map[s.charAt(i)] = s.charAt((i+13)%26);</span>
<span class="hh">        for (i=0; i&lt;s.length; i++)</span>
<span class="hh">            map[s.charAt(i).toUpperCase()] = s.charAt((i+13)%26).toUpperCase();</span>

<span class="hh">        Rot13.map = map;</span>
<span class="hh">    },</span>

<span class="hh">    write: function(a) {</span>
<span class="hh">        return(Rot13.convert(a));</span>
<span class="hh">    }</span>
<span class="hh">}</span>


<span class="hh">Rot13.write(&#39;&lt;n uers=&quot;znvygb:grfg@rknzcyr.pbz&quot;&gt;grfg&lt;/n&gt;&#39;);</span>
<span class="h">JS</span>

<span class="k">print</span> <span class="i">$v</span><span class="i">-&gt;value</span><span class="sc">;</span>
</pre>

<p>上面的代码我们使用了一点点小技巧，我们将 document.write 转成了 return, 这样我们会得到一个 <tt><a href="http://search.cpan.org/perldoc?JE::String">JE::String</a></tt> 然后通过输出 ->value 来得到真正的 <a href="mailto:test@example.com">test</a></p>
<p>上面的东西看上去有点小无聊，自己破解自己加密的东西，但是您可以使用它来解密或者运行其他的 js 代码，这都将变得非常有趣。</p>
<p>Enjoy!</p>
<div style="float: right; font-size: 10pt"><a href="JE.pod">View Source (POD)</a></div><br />
</body>
</html>
