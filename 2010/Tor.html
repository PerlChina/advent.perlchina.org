<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
   "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<!-- Generated by Pod::Advent 0.20 (Pod::Simple 3.13, Perl::Tidy 20090616) on 2010-12-02 02:01:35 -->
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<title>2010 Perl Advent Calendar: Tor</title>
<meta http-equiv="content-type" content="text/html; charset=utf-8" />
<link rel="stylesheet" href="../style.css" type="text/css" />
<link rel="alternate" type="text/plain" href="Tor.pod" />
</head>
<body>
<h1><a href="../">Perl Advent Calendar 2010-12</a>-02</h1>
<h2 align="center">Tor</h2>
<h3 align="center">by Fayland Lam</h3>
<p>在国内混，爬墙是必备技能。爬墙有很多种，SSH Tunnel, VPN, Tor 等。如果仅仅是个人使用的话，SSH Tunnel 或者 VPN 都是不错的选择，速度够快，但是可能不免费。Tor 是一个免费的选择，虽然有时候可能有点慢。</p>
<p>如果要做爬虫工具的话，Tor 将是一个必备选择。虽然有时候它不稳定或者某些网站不欢迎它，但是大部分情况下，它都可以很好的工作。</p>
<p>本篇并非爬墙介绍篇或者下载安装篇，而是给某些有了套（Tor）但不知道咋用的童鞋一点提示。:)</p>
<p>如果你能自己初始化 ua (<tt><a href="http://search.cpan.org/perldoc?LWP::UserAgent">LWP::UserAgent</a></tt> 或 <tt><a href="http://search.cpan.org/perldoc?WWW::Mechanize">WWW::Mechanize</a></tt>) ，我们可以通过 <tt><a href="http://search.cpan.org/perldoc?LWP::Protocol::socks">LWP::Protocol::socks</a></tt> 来设置</p>
<pre>
    <span class="i">$ua</span><span class="i">-&gt;proxy</span><span class="s">(</span><span class="s">[</span><span class="q">&#39;http&#39;</span><span class="cm">,</span> <span class="q">&#39;https&#39;</span><span class="s">]</span><span class="cm">,</span> <span class="q">&#39;socks://127.0.0.1:7070&#39;</span><span class="s">)</span><span class="sc">;</span> <span class="c"># SSH Tunnel</span>
    <span class="i">$ua</span><span class="i">-&gt;proxy</span><span class="s">(</span><span class="s">[</span><span class="q">&#39;http&#39;</span><span class="cm">,</span> <span class="q">&#39;https&#39;</span><span class="s">]</span><span class="cm">,</span> <span class="q">&#39;socks://127.0.0.1:9050&#39;</span><span class="s">)</span><span class="sc">;</span> <span class="c"># Tor port</span>

    <span class="i">$ua</span>-&gt;{<span class="w">proxy</span>} = <span class="s">{</span><span class="s">}</span><span class="sc">;</span> <span class="c"># remove proxy</span>
</pre>
<p>但是如果我们无法得到某些模块的 ua 时，比如 <tt><a href="http://search.cpan.org/perldoc?Facebook::Graph">Facebook::Graph</a></tt> 或者 <tt><a href="http://search.cpan.org/perldoc?Net::Twitter">Net::Twitter</a></tt>，我们可以通过 <tt><a href="http://search.cpan.org/perldoc?LWP::Protocol::http::SocksChain">LWP::Protocol::http::SocksChain</a></tt> 和 <a href="LWP::Protocol::https::SocksChain">LWP::Protocol::https::SocksChain</a> 直接更改最底层的 LWP protocol</p>
<pre>
    <span class="k">use</span> <span class="w">LWP::Protocol::http::SocksChain</span><span class="sc">;</span>
    <span class="k">use</span> <span class="w">LWP::Protocol::https::SocksChain</span><span class="sc">;</span>

    <span class="c"># set proxy</span>
    <span class="i">LWP::Protocol::implementor</span><span class="s">(</span> <span class="w">http</span> <span class="cm">=&gt;</span> <span class="q">&#39;LWP::Protocol::http::SocksChain&#39;</span> <span class="s">)</span><span class="sc">;</span>
    <span class="i">@LWP::Protocol::http::SocksChain::EXTRA_SOCK_OPTS</span> = <span class="s">(</span>
        <span class="w">Chain_Len</span>    <span class="cm">=&gt;</span> <span class="n">1</span><span class="cm">,</span>
        <span class="w">Debug</span>        <span class="cm">=&gt;</span> <span class="n">0</span><span class="cm">,</span>
        <span class="w">Random_Chain</span> <span class="cm">=&gt;</span> <span class="n">1</span><span class="cm">,</span>
        <span class="w">Chain_File_Data</span> <span class="cm">=&gt;</span> <span class="s">[</span> <span class="q">&#39;127.0.0.1:9050:::4&#39;</span> <span class="s">]</span><span class="cm">,</span> <span class="c"># or [ &#39;127.0.0.1:7070&#39; ],</span>
        <span class="w">Auto_Save</span>    <span class="cm">=&gt;</span> <span class="n">0</span><span class="cm">,</span>
        <span class="w">Restore_Type</span> <span class="cm">=&gt;</span> <span class="n">0</span>
    <span class="s">)</span><span class="sc">;</span>

    <span class="i">LWP::Protocol::implementor</span><span class="s">(</span> <span class="w">https</span> <span class="cm">=&gt;</span> <span class="q">&#39;LWP::Protocol::https::SocksChain&#39;</span> <span class="s">)</span><span class="sc">;</span>
    <span class="i">@LWP::Protocol::https::SocksChain::EXTRA_SOCK_OPTS</span> = <span class="s">(</span>
        <span class="w">Chain_Len</span>    <span class="cm">=&gt;</span> <span class="n">1</span><span class="cm">,</span>
        <span class="w">Debug</span>        <span class="cm">=&gt;</span> <span class="n">0</span><span class="cm">,</span>
        <span class="w">Random_Chain</span> <span class="cm">=&gt;</span> <span class="n">1</span><span class="cm">,</span>
        <span class="w">Chain_File_Data</span> <span class="cm">=&gt;</span> <span class="s">[</span> <span class="q">&#39;127.0.0.1:9050:::4&#39;</span> <span class="s">]</span><span class="cm">,</span> <span class="c"># or [ &#39;127.0.0.1:7070&#39; ],</span>
        <span class="w">Auto_Save</span>    <span class="cm">=&gt;</span> <span class="n">0</span><span class="cm">,</span>
        <span class="w">Restore_Type</span> <span class="cm">=&gt;</span> <span class="n">0</span>
    <span class="s">)</span><span class="sc">;</span>

    <span class="c"># clear proxy</span>
    <span class="i">LWP::Protocol::implementor</span><span class="s">(</span> <span class="w">http</span> <span class="cm">=&gt;</span> <span class="q">&#39;LWP::Protocol::http&#39;</span> <span class="s">)</span><span class="sc">;</span>
    <span class="i">LWP::Protocol::implementor</span><span class="s">(</span> <span class="w">https</span> <span class="cm">=&gt;</span> <span class="q">&#39;LWP::Protocol::https&#39;</span> <span class="s">)</span><span class="sc">;</span>
</pre>
<p>OK, 写出来都是很简单的代码。祝各位用套愉快。:)</p>
<h1>POD ERRORS</h1>
<p>Hey! <span style="font-weight: bold">The above document had some coding errors, which are explained below:</span></p>
Around line 17:<p>Unknown directive: =pre</p>
Around line 24:<p>'=end' without a target?</p>
Around line 28:<p>Unknown directive: =pre</p>
Around line 58:<p>'=end' without a target?</p>
<div style="float: right; font-size: 10pt"><a href="Tor.pod">View Source (POD)</a></div><br />
</body>
</html>
