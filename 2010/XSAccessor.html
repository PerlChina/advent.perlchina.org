<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
   "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<!-- Generated by Pod::Advent 0.21 (Pod::Simple 3.13, Perl::Tidy 20090616) on 2010-12-14 05:52:05 -->
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<title>2010 Perl Advent Calendar: Class::XSAccessor</title>
<meta http-equiv="content-type" content="text/html; charset=utf-8" />
<link rel="stylesheet" href="../style.css" type="text/css" />
<link rel="alternate" type="text/plain" href="XSAccessor.pod" />
</head>
<body>
<h1><a href="index.html">Perl Advent Calendar 2010-12</a>-14</h1>
<h2 align="center">Class::XSAccessor</h2>
<h3 align="center">by Fayland Lam</h3>
<p>创建所谓的 accessor 应该是件很普遍的事情，对于对象来说，大部分的属性都是 accessor. 因为这个功能的普遍性，CPAN 上大概有超过 20 个模块可以完成这个任务。其中最有名的应该是 <tt><a href="http://search.cpan.org/perldoc?Moose">Moose</a></tt>, <tt><a href="http://search.cpan.org/perldoc?Mouse">Mouse</a></tt> 或者是 mst 刚开发的更轻量级的 <tt><a href="http://search.cpan.org/perldoc?Moo">Moo</a></tt>. 或许大家用过的有 <tt><a href="http://search.cpan.org/perldoc?Class::Accessor">Class::Accessor</a></tt>, <tt><a href="http://search.cpan.org/perldoc?Class::Accessor::Fast">Class::Accessor::Fast</a></tt> 或者 <tt><a href="http://search.cpan.org/perldoc?Class::MethodMaker">Class::MethodMaker</a></tt>. 今天要推荐的是目前来说最快速的 <tt><a href="http://search.cpan.org/perldoc?Class::XSAccessor">Class::XSAccessor</a></tt>.</p>
<p>Class::XSAccessor 最初是为了加速和简化 <tt><a href="http://search.cpan.org/perldoc?Padre">Padre</a></tt> 的代码而开发，用法与其他的 accessor 模块大同小异。</p>
<pre>
<a name="package-MyClass"></a><span class="k">package </span><span class="i">MyClass</span><span class="sc">;</span>

<span class="k">use</span> <span class="w">Class::XSAccessor</span>
    <span class="w">replace</span>     <span class="cm">=&gt;</span> <span class="n">1</span><span class="cm">,</span>   <span class="c"># Replace existing methods (if any)</span>
    <span class="w">constructor</span> <span class="cm">=&gt;</span> <span class="q">&#39;new&#39;</span><span class="cm">,</span>
    <span class="w">getters</span>     <span class="cm">=&gt;</span> <span class="s">{</span>
      <span class="w">get_foo</span> <span class="cm">=&gt;</span> <span class="q">&#39;foo&#39;</span><span class="cm">,</span> <span class="c"># &#39;foo&#39; is the hash key to access</span>
      <span class="w">get_bar</span> <span class="cm">=&gt;</span> <span class="q">&#39;bar&#39;</span><span class="cm">,</span>
    <span class="s">}</span><span class="cm">,</span>
    <span class="w">setters</span> <span class="cm">=&gt;</span> <span class="s">{</span>
      <span class="w">set_foo</span> <span class="cm">=&gt;</span> <span class="q">&#39;foo&#39;</span><span class="cm">,</span>
      <span class="w">set_bar</span> <span class="cm">=&gt;</span> <span class="q">&#39;bar&#39;</span><span class="cm">,</span>
    <span class="s">}</span><span class="cm">,</span>
    <span class="w">accessors</span> <span class="cm">=&gt;</span> <span class="s">[</span> <span class="q">&#39;foo&#39;</span><span class="cm">,</span> <span class="q">&#39;bar&#39;</span> <span class="s">]</span><span class="cm">,</span>
    <span class="w">predicates</span> <span class="cm">=&gt;</span> <span class="s">{</span>
      <span class="w">has_foo</span> <span class="cm">=&gt;</span> <span class="q">&#39;foo&#39;</span><span class="cm">,</span>
      <span class="w">has_bar</span> <span class="cm">=&gt;</span> <span class="q">&#39;bar&#39;</span><span class="cm">,</span>
    <span class="s">}</span><span class="cm">,</span>
    <span class="w">lvalue_accessors</span> <span class="cm">=&gt;</span> <span class="s">{</span> <span class="w">zip_code</span> <span class="cm">=&gt;</span> <span class="q">&#39;zip&#39;</span> <span class="s">}</span><span class="sc">;</span>
    <span class="w">true</span>  <span class="cm">=&gt;</span> <span class="s">[</span> <span class="q">&#39;is_token&#39;</span><span class="cm">,</span> <span class="q">&#39;is_whitespace&#39;</span> <span class="s">]</span><span class="cm">,</span>
    <span class="w">false</span> <span class="cm">=&gt;</span> <span class="s">[</span> <span class="q">&#39;significant&#39;</span> <span class="s">]</span><span class="sc">;</span>
</pre>

<p>几个简单的解释是，</p>
<p>* constructor => 'new' 意味着你不用写无聊的 new 了。</p>
<p>* accessors => [] 是最常用的，因为大部分情况下 getter 和 setter 的名字会是一样的。</p>
<p>* lvalue 是个比较 fun 的功能。比如上面的设置可以有如下的测试代码</p>
<pre>
  <span class="k">my</span> <span class="i">$address</span> = <span class="w">MyClass</span><span class="w">-&gt;new</span><span class="s">(</span><span class="w">zip</span> <span class="cm">=&gt;</span> <span class="n">2</span><span class="s">)</span><span class="sc">;</span>
  <span class="k">print</span> <span class="i">$address</span><span class="i">-&gt;zip_code</span><span class="cm">,</span> <span class="q">&quot;\n&quot;</span><span class="sc">;</span> <span class="c"># prints 2</span>
  <span class="i">$address</span><span class="i">-&gt;zip_code</span> = <span class="n">76135</span><span class="sc">;</span> <span class="c"># &lt;--- This is it!</span>
  <span class="k">print</span> <span class="i">$address</span><span class="i">-&gt;zip_code</span><span class="cm">,</span> <span class="q">&quot;\n&quot;</span><span class="sc">;</span> <span class="c"># prints 76135</span>
</pre>

<p>某些极端要求速度的人，会认为 bless 一个 hashref 给 class 是件很浪费的事情，他们说应该 bless 一个 arrayref 给 class 才是正确的。这种情况下，我们可以使用 <a href="Class::XSAccessor::Array">Class::XSAccessor::Array</a>, 它更给力。</p>
<p>当然，如果你需要说服你的上级或者你自己，你需要一个对大部分流行的 accessor 模块的 benchmark，我们也有这样的东西。简单的安装 <tt><a href="http://search.cpan.org/perldoc?App::Benchmark::Accessors">App::Benchmark::Accessors</a></tt>, 你就能得到你所需要的结果。</p>
<p>类似的结果可以参考 <a href="http://www.cpantesters.org/distro/A/App-Benchmark-Accessors.html">http://www.cpantesters.org/distro/A/App-Benchmark-Accessors.html</a> 里的 test reporters，我就不重复 copy 我自己的结果了。</p>
<p>Enjoy!</p>
<div style="float: right; font-size: 10pt"><a href="XSAccessor.pod">View Source (POD)</a></div><br />
</body>
</html>
