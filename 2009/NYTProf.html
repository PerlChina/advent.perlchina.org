<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
   "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<!-- Generated by Pod::Advent 0.18 (Pod::Simple 3.07, Perl::Tidy 20071205) on 2009-12-10 21:24:22 -->
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="content-type" content="text/html; charset=utf-8" />
<title>2009 CN Perl Advent Calendar: Devel::NYTProf</title>
<link rel="stylesheet" href="../style.css" type="text/css" />
<link rel="alternate" type="text/plain" href="NYTProf.pod" />
</head>
<body>
<h1><a href="../">CN Perl Advent Calendar 2009-12</a>-11</h1>
<h2 align="center">Devel::NYTProf</h2>
<h3 align="center">by Fayland Lam</h3>
<p>当您有个程序运行得特别慢而无法找到为什么的时候，Profile 当是第一选择（Profile 应当永远在优化之前）。而在 CPAN 众多 Profile 模块中，<a href="Devel::NYTProf">Devel::NYTProf</a> 当属第一。</p>
<p>比如你有一个简单的 pl 文件</p>
<pre>
<span class="k">use</span> <span class="w">strict</span><span class="sc">;</span>
<span class="k">use</span> <span class="w">warnings</span><span class="sc">;</span>
<span class="k">use</span> <span class="w">List::Util</span> <span class="q">qw/shuffle/</span><span class="sc">;</span>

<span class="k">my</span> <span class="i">@list</span> = <span class="s">(</span><span class="n">1</span> .. <span class="n">1000000</span><span class="s">)</span><span class="sc">;</span>
<span class="i">@list</span> = <span class="w">shuffle</span> <span class="i">@list</span><span class="sc">;</span>
<span class="i">@list</span> = <span class="k">splice</span><span class="s">(</span><span class="i">@list</span><span class="cm">,</span> <span class="n">0</span><span class="cm">,</span> <span class="n">300</span><span class="s">)</span><span class="sc">;</span>

<span class="k">my</span> <span class="i">@listB</span><span class="sc">;</span>
<span class="k">while</span> <span class="s">(</span><span class="k">scalar</span> <span class="i">@listB</span> &lt; <span class="n">300</span><span class="s">)</span> <span class="s">{</span>
    <span class="k">my</span> <span class="i">$value</span> = <span class="k">int</span><span class="s">(</span><span class="k">rand</span><span class="s">(</span><span class="n">1000000</span><span class="s">)</span><span class="s">)</span><span class="sc">;</span>
    <span class="k">unless</span> <span class="s">(</span> <span class="k">grep</span> <span class="s">{</span> <span class="i">$_</span> == <span class="i">$value</span> <span class="s">}</span> <span class="i">@listB</span> <span class="s">)</span> <span class="s">{</span>
        <span class="k">push</span> <span class="i">@listB</span><span class="cm">,</span> <span class="i">$value</span><span class="sc">;</span>
    <span class="s">}</span>
<span class="s">}</span>
</pre>

<p>运行如下</p>
<pre><span class="c">$ perl -d:NYTProf t.pl
$ nytprofhtml</span></pre>
<p>然后你就可以打开 nytprof/index.html 了</p>
<p><img src='NYTProf1.jpg' /></p>
<p>如果点 t.pl 左边的 line, 你能清楚地看到哪一行是比较慢的。</p>
<p><img src='NYTProf2.jpg' /></p>
<p>如上脚本只是为了简单介绍，实际中的应该比这复杂多了。但是方法还是一样的。</p>
<p>Devel::NYTProf 不仅仅可以对一个 pl 脚本，还可以在 mod_perl 下测试 web 脚本。比如我们的 Catalyst 脚本，只要在 httpd.conf 里设置</p>
<pre><span class="c">  PerlSetEnv NYTPROF file=/root/nytprof.out
  PerlModule Devel::NYTProf::Apache</span></pre>
<p>然后重启 Apache, 访问一些网站地址，然后 stop Apache. 在 /root/nytprof.out* 中选取一个文件，然后运行 nytprofhtml -f nytprof.out.XX 即可。</p>
<p>更多更详尽的请参考 <tt><a href="http://search.cpan.org/perldoc?Devel::NYTProf">Devel::NYTProf</a></tt> 文档和网络中的一些 slide, 如有遇到无法解决的问题，请来<a href="http://groups.google.com/group/perlchina">Perlchina 的邮件列表</a>询问。</p>
<p>谢谢。</p>
<div style="float: right; font-size: 10pt"><a href="NYTProf.pod">View Source (POD)</a></div><br />
</body>
</html>
