<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
   "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<!-- Generated by Pod::Advent 0.17 (Pod::Simple 3.07, Perl::Tidy 20071205) on 2009-12-03 09:05:03 -->
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="content-type" content="text/html; charset=utf-8" />
<title>2009 CN Perl Advent Calendar: End Scope</title>
<link rel="stylesheet" href="../style.css" type="text/css" />
<link rel="alternate" type="text/plain" href="EndScope.pod" />
</head>
<body>
<h1><a href="../">CN Perl Advent Calendar 2009-12</a>-03</h1>
<h2 align="center">End Scope</h2>
<h3 align="center">by Fayland Lam</h3>
<p>CPAN 上有很多支持在 scope 结束后运行某些代码，其中最常用的是 <tt><a href="http://search.cpan.org/perldoc?Scope::Guard">Scope::Guard</a></tt> 和 <tt><a href="http://search.cpan.org/perldoc?B::Hooks::EndOfScope">B::Hooks::EndOfScope</a></tt></p>
<p><tt>Scope::Guard</tt> 采用最常见的 <span style="font-weight: bold">DESTROY</span> 方法。Scope::Guard 可以通过 dismiss 来取消。</p>
<pre>
   1 <span class="k">use</span> <span class="w">Net::FTP</span><span class="sc">;</span>
   2 <span class="k">use</span> <span class="w">Scope::Guard</span><span class="sc">;</span>
   3 
   4 <span class="s">{</span>
   5     <span class="k">my</span> <span class="i">$err</span><span class="sc">;</span>
   6     <span class="k">my</span> <span class="i">$sg</span> = <span class="w">Scope::Guard</span><span class="w">-&gt;new</span><span class="s">(</span>
   7         <span class="k">sub</span> <span class="s">{</span> <span class="i">email_error</span><span class="s">(</span><span class="i">$err</span><span class="s">)</span><span class="sc">;</span> <span class="k">die</span> <span class="i">$err</span><span class="sc">;</span> <span class="s">}</span>
   8     <span class="s">)</span><span class="sc">;</span>
   9     <span class="k">my</span> <span class="i">$ftp</span> = <span class="w">Net::FTP</span><span class="w">-&gt;new</span><span class="s">(</span><span class="i">$host</span><span class="cm">,</span> <span class="w">Debug</span> <span class="cm">=&gt;</span> <span class="n">0</span><span class="s">)</span>
  10       <span class="k">or</span> <span class="k">do</span> <span class="s">{</span> <span class="k">return</span> <span class="i">$err</span> = <span class="q">&quot;Cannot connect to $host: $@&quot;</span><span class="sc">;</span> <span class="s">}</span><span class="sc">;</span>
  11     <span class="i">$ftp</span><span class="i">-&gt;login</span><span class="s">(</span><span class="i">$user</span><span class="cm">,</span> <span class="i">$pass</span><span class="s">)</span>
  12       <span class="k">or</span> <span class="k">do</span> <span class="s">{</span> <span class="k">return</span> <span class="i">$err</span> = <span class="q">&quot;Cannot login &quot;</span> . <span class="i">$ftp</span><span class="i">-&gt;message</span><span class="sc">;</span> <span class="s">}</span><span class="sc">;</span>
  13 
  14     <span class="i">$sg</span><span class="i">-&gt;dismiss</span><span class="s">(</span><span class="s">)</span><span class="sc">;</span>
  15 <span class="s">}</span>
</pre>

<p><tt>B::Hooks::EndOfScope</tt> 使用 <tt><a href="http://search.cpan.org/perldoc?Variable::Magic">Variable::Magic</a></tt> 中的魔术 <span style="font-weight: bold">$^H</span>. EndOfScope 的强悍之处在于支持 Moose 的方法修改，并且支持多个 on_scope_end 加载。</p>
<pre>
   1     <span class="c"># Make sure that the application class becomes immutable at this point,</span>
   2     <span class="c"># which ensures that it gets an inlined constructor. This means that it</span>
   3     <span class="c"># works even if the user has added a plugin which contains a new method.</span>
   4     <span class="c"># Note however that we have to do the work on scope end, so that method</span>
   5     <span class="c"># modifiers work correctly in MyApp (as you have to call setup _before_</span>
   6     <span class="c"># applying modifiers).</span>
   7     <span class="i">B::Hooks::EndOfScope::on_scope_end</span> <span class="s">{</span>
   8         <span class="k">return</span> <span class="k">if</span> <span class="i">$@</span><span class="sc">;</span>
   9         <span class="k">my</span> <span class="i">$meta</span> = <span class="i">Class::MOP::get_metaclass_by_name</span><span class="s">(</span><span class="i">$class</span><span class="s">)</span><span class="sc">;</span>
  10         <span class="k">if</span> <span class="s">(</span> <span class="i">$meta</span><span class="i">-&gt;is_immutable</span> &amp;&amp; ! <span class="s">{</span> <span class="i">$meta</span><span class="i">-&gt;immutable_options</span> <span class="s">}</span>-&gt;{<span class="w">inline_constructor</span>} <span class="s">)</span> <span class="s">{</span>
  11             <span class="k">warn</span> <span class="q">&quot;You made your application class ($class) immutable, &quot;</span>
  12                 . <span class="q">&quot;but did not inline the constructor.\n&quot;</span>
  13                 . <span class="q">&quot;This will break catalyst, please pass &quot;</span>
  14                 . <span class="q">&quot;(replace_constructor =&gt; 1) when making your class immutable.\n&quot;</span><span class="sc">;</span>
  15         <span class="s">}</span>
  16         <span class="i">$meta</span><span class="i">-&gt;make_immutable</span><span class="s">(</span><span class="w">replace_constructor</span> <span class="cm">=&gt;</span> <span class="n">1</span><span class="s">)</span> <span class="k">unless</span> <span class="i">$meta</span><span class="i">-&gt;is_immutable</span><span class="sc">;</span>
  17     <span class="s">}</span><span class="sc">;</span>
  18 
  19     <span class="i">$class</span><span class="i">-&gt;setup_finalize</span><span class="sc">;</span>
</pre>

<p>上述代码来自 <a href="Catalyst">Catalyst</a></p>
<p>我们一般在多处 return, next 或复杂子程序调用的时候，为了使代码更简洁而采用上述模块。</p>
<p>谢谢。</p>
<div style="float: right; font-size: 10pt"><a href="EndScope.pod">View Source (POD)</a></div><br />
</body>
</html>
