<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
   "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<!-- Generated by Pod::Advent 0.18 (Pod::Simple 3.07, Perl::Tidy 20071205) on 2009-12-17 07:49:19 -->
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="content-type" content="text/html; charset=utf-8" />
<title>2009 CN Perl Advent Calendar: dzil</title>
<link rel="stylesheet" href="../style.css" type="text/css" />
<link rel="alternate" type="text/plain" href="dzil.pod" />
</head>
<body>
<h1><a href="index.html">CN Perl Advent Calendar 2009-12</a>-17</h1>
<h2 align="center">dzil</h2>
<h3 align="center">by Fayland Lam</h3>
<p><a href="Dist::Zilla">Dist::Zilla</a> 对模块作者来说是件利器。</p>
<p>它与 <tt><a href="http://search.cpan.org/perldoc?ExtUtils::MakeMaker">ExtUtils::MakeMaker</a></tt>, <tt><a href="http://search.cpan.org/perldoc?Module::Build">Module::Build</a></tt>, <tt><a href="http://search.cpan.org/perldoc?Module::Install">Module::Install</a></tt> 不同，它不是安装模块。它们的共同点是都可以打包一个 CPAN .tar.gz</p>
<p>它与 <tt><a href="http://search.cpan.org/perldoc?Module::Starter">Module::Starter</a></tt> 不同。它不仅仅可以构建模块的框架。</p>
<p>它与 <tt><a href="http://search.cpan.org/perldoc?ShipIt">ShipIt</a></tt> 不同。它不仅仅可以发布代码。</p>
<p>它是所有的综合体。它可以构建框架，打包代码并且发布代码，它最大的优点在于节省您的时间。让你专心编写代码而无需考虑多余的事情。</p>
<p>以下是一个简单的流程例子。</p>
<p>通常我们会在我们的 home 目录下创建一个 .dzil/config.ini 来保存模块配置的基本资料。</p>
<pre><span class="c">$ mkdir ~/.dzil
$ vi ~/.dzil/config.ini

# Windows 一般是
C:\Documents and Settings\Administrator>perl -e "mkdir '.dzil'"
C:\Documents and Settings\Administrator>cd .dzil
C:\Documents and Settings\Administrator\.dzil>notepad config.ini</span></pre>
<p>config.ini 里的内容（可以添加更多的，下文会提到）</p>
<pre><span class="c">[=Dist::Zilla::App::Command::new]
author  = Fayland Lam <fayland@gmail.com>
license = Perl_5
copyright_holder = Fayland Lam</span></pre>
<p>最好基本个人资料配置之后，我们就可以创建一个新的 dist.ini 模块了。</p>
<pre><span class="c">$ dzil new TestModule-A</span></pre>
<p>打开 TestModule-A 目录，会有一个 dist.ini 文件</p>
<pre><span class="c">name    = TestModule-A
version = 1.000
author  = Fayland Lam <fayland@gmail.com>
license = Perl_5
copyright_holder = Fayland Lam

[@Classic]</span></pre>
<p>与 Module::Starter 不同，它并不创建任何目录或其他文件。大部分的文件都将通过 dist.ini 来配置生成。</p>
<p>比如 Makefile.PL, 默认的 [@Classic] 会在 dzil build 的时候自动生成。</p>
<p>比如 README, 我们可以用默认的 [@Classic] 来生成一个简单的，或者也可以通过 <tt><a href="http://search.cpan.org/perldoc?Dist::Zilla::Plugin::ReadmeFromPod">Dist::Zilla::Plugin::ReadmeFromPod</a></tt> 来从 POD 生成。</p>
<p>比如 POD 里的 NAME, AUTHOR 和 COPYRIGHT AND LICENSE，都将通过 <tt><a href="http://search.cpan.org/perldoc?Dist::Zilla::Plugin::PodWeaver">Dist::Zilla::Plugin::PodWeaver</a></tt> 来生成。</p>
<p>比如一些 Repository 的资料，可以通过 <tt><a href="http://search.cpan.org/perldoc?Dist::Zilla::Plugin::Repository">Dist::Zilla::Plugin::Repository</a></tt> 来生成。</p>
<p>比如 t/00-compile.t 可以通过 <tt><a href="http://search.cpan.org/perldoc?Dist::Zilla::Plugin::CompileTests">Dist::Zilla::Plugin::CompileTests</a></tt> 生成。</p>
<p>想想看，如果上面的文件都将默认生成，你还需要做什么呢？您只需要写真正有意义的代码了，而不需要关心这些枝节。</p>
<pre><span class="c">$ mkdir lib/TestModule/A.pm
$ vi lib/TestModule/A.pm
package TestModule::A;
# ABSTRACT: [[Abstract of module]]

use strict;
use warnings;
use Module::A;
use Module::B;

[[YOUR CODE]]

1;
__END__
=head1 SYNOPSIS

[[YOUR SYNOPSIS]]
=head1 DESCRIPTION

[[YOUR DESCRIPTION]]</span></pre>
<p>ABSTRACT 将是 NAME head1 的描述。</p>
<p>最后您可以还忘记了 Changes</p>
<pre><span class="c">$ vi Changes
Revision history for TestModule::A

0.01    2009.12.15
        First version, released on an unsuspecting world.</span></pre>
<p>是不是写 Changes 有点繁琐？您可以写一个 plugin 来自动生成 Changes. 是不是经常会在发布前忘记更新 Changes, 可以使用 <tt><a href="http://search.cpan.org/perldoc?Dist::Zilla::Plugin::CheckChangeLog">Dist::Zilla::Plugin::CheckChangeLog</a></tt> 来提醒你。</p>
<p>最后的 dist.ini 可能是这样的</p>
<pre><span class="c">name    = TestModule-A
version = 1.000
author  = Fayland Lam <fayland@gmail.com>
license = Perl_5
copyright_holder = Fayland Lam

[@Classic]

[Prereq]
Module::A = 0
Module::B = 0

[PodWeaver]
[Repository]
[ReadmeFromPod]
[CheckChangeLog]</span></pre>
<p>在更改模块完毕后，您可以</p>
<pre><span class="c">$ dzil test
$ dzil build
$ dzil release</span></pre>
<p>来测试，打包和发布代码。</p>
<p>如果上述对您来说还是太繁琐的话，您可以写 Dist::Zilla 的插件。Dist::Zilla 里有个插件的技巧</p>
<pre>
  <span class="i">$_</span><span class="i">-&gt;before_build</span> <span class="k">for</span> <span class="i">$self</span><span class="i">-&gt;plugins_with</span><span class="s">(</span>-<span class="w">BeforeBuild</span><span class="s">)</span><span class="i">-&gt;flatten</span><span class="sc">;</span>

  <span class="i">$_</span><span class="i">-&gt;gather_files</span>    <span class="k">for</span> <span class="i">$self</span><span class="i">-&gt;plugins_with</span><span class="s">(</span>-<span class="w">FileGatherer</span><span class="s">)</span><span class="i">-&gt;flatten</span><span class="sc">;</span>
  <span class="i">$_</span><span class="i">-&gt;prune_files</span>     <span class="k">for</span> <span class="i">$self</span><span class="i">-&gt;plugins_with</span><span class="s">(</span>-<span class="w">FilePruner</span><span class="s">)</span><span class="i">-&gt;flatten</span><span class="sc">;</span>
  <span class="i">$_</span><span class="i">-&gt;munge_files</span>     <span class="k">for</span> <span class="i">$self</span><span class="i">-&gt;plugins_with</span><span class="s">(</span>-<span class="w">FileMunger</span><span class="s">)</span><span class="i">-&gt;flatten</span><span class="sc">;</span>
  <span class="i">$_</span><span class="i">-&gt;setup_installer</span> <span class="k">for</span> <span class="i">$self</span><span class="i">-&gt;plugins_with</span><span class="s">(</span>-<span class="w">InstallTool</span><span class="s">)</span><span class="i">-&gt;flatten</span><span class="sc">;</span>
</pre>

<p>可以让你分步骤来编写对应的插件。目前 CPAN 上有很多插件如 <tt><a href="http://search.cpan.org/perldoc?Dist::Zilla::Plugin::Git">Dist::Zilla::Plugin::Git</a></tt>, <tt><a href="http://search.cpan.org/perldoc?Dist::Zilla::Plugin::PerlTidy">Dist::Zilla::Plugin::PerlTidy</a></tt>, <tt><a href="http://search.cpan.org/perldoc?Dist::Zilla::Plugin::Prepender">Dist::Zilla::Plugin::Prepender</a></tt>, <tt><a href="http://search.cpan.org/perldoc?Dist::Zilla::Plugin::Release">Dist::Zilla::Plugin::Release</a></tt> 等，都是非常有用和尝试的。</p>
<p>谢谢。</p>
<div style="float: right; font-size: 10pt"><a href="dzil.pod">View Source (POD)</a></div><br />
</body>
</html>
