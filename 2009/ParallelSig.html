<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
   "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<!-- Generated by Pod::Advent 0.18 (Pod::Simple 3.07, Perl::Tidy 20071205) on 2009-12-18 21:21:50 -->
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="content-type" content="text/html; charset=utf-8" />
<title>2009 CN Perl Advent Calendar: Parallel::Prefork 和 SIG</title>
<link rel="stylesheet" href="../style.css" type="text/css" />
<link rel="alternate" type="text/plain" href="ParallelSig.pod" />
</head>
<body>
<h1><a href="../">CN Perl Advent Calendar 2009-12</a>-18</h1>
<h2 align="center">Parallel::Prefork 和 SIG</h2>
<h3 align="center">by Fayland Lam</h3>
<p>如果一个 daemon 处理队列太慢（或其他情况），<tt><a href="http://search.cpan.org/perldoc?Parallel::ForkManager">Parallel::ForkManager</a></tt> 和 <tt><a href="http://search.cpan.org/perldoc?Parallel::Prefork">Parallel::Prefork</a></tt> 都是很不错的选择。</p>
<p>下面的代码来自我们实际运行中的一个 <tt><a href="http://search.cpan.org/perldoc?TheSchwartz">TheSchwartz</a></tt> worker 的 daemon, 实际上很大一部分都是拷贝自 <a href="http://d.hatena.ne.jp/tokuhirom/20081110/1226291955">http://d.hatena.ne.jp/tokuhirom/20081110/1226291955</a></p>
<pre>
   1 <span class="k">use</span> <span class="w">strict</span><span class="sc">;</span>
   2 <span class="k">use</span> <span class="w">warnings</span><span class="sc">;</span>
   3 
   4 <span class="k">my</span> <span class="i">$has_proc_pid_file</span>
   5     = <span class="k">eval</span> <span class="q">&#39;use Proc::PID::File; 1;&#39;</span><span class="sc">;</span>    <span class="c">## no critic (ProhibitStringyEval)</span>
   6 <span class="k">my</span> <span class="i">$has_home_dir</span>
   7     = <span class="k">eval</span> <span class="q">&#39;use File::HomeDir; 1;&#39;</span><span class="sc">;</span>      <span class="c">## no critic (ProhibitStringyEval)</span>
   8 <span class="k">if</span> <span class="s">(</span> <span class="i">$has_proc_pid_file</span> <span class="k">and</span> <span class="i">$has_home_dir</span> <span class="s">)</span> <span class="s">{</span>
   9     <span class="c"># If already running, then exit</span>
  10     <span class="k">if</span> <span class="s">(</span> <span class="w">Proc::PID::File</span><span class="w">-&gt;running</span><span class="s">(</span> <span class="s">{</span> <span class="w">dir</span> <span class="cm">=&gt;</span> <span class="w">File::HomeDir</span><span class="w">-&gt;my_home</span> <span class="s">}</span> <span class="s">)</span> <span class="s">)</span> <span class="s">{</span>
  11         <span class="k">exit</span><span class="s">(</span><span class="n">0</span><span class="s">)</span><span class="sc">;</span>
  12     <span class="s">}</span>
  13 <span class="s">}</span>
  14 
  15 <span class="k">use</span> <span class="w">UNIVERSAL::require</span><span class="sc">;</span>
  16 <span class="k">use</span> <span class="w">Parallel::Prefork</span><span class="sc">;</span>
  17 
  18 <span class="k">my</span> <span class="i">@workers</span> = <span class="q">qw/</span>
  19     <span class="q">TheSchwartz::JobA</span>
  20     <span class="q">TheSchwartz::JobB</span>
  21     <span class="q">TheSchwartz::JobC</span>
  22 <span class="q">/</span><span class="sc">;</span>
  23 <span class="k">foreach</span> <span class="k">my</span> <span class="i">$worker</span> <span class="s">(</span><span class="i">@workers</span><span class="s">)</span> <span class="s">{</span>
  24     <span class="k">print</span> <span class="q">&quot;setup $worker\n&quot;</span><span class="sc">;</span>
  25     <span class="i">$worker</span><span class="i">-&gt;use</span> <span class="k">or</span> <span class="k">die</span> <span class="i">$@</span><span class="sc">;</span>
  26 <span class="s">}</span>
  27 
<a name="MaxRequestsPerChild"></a>  28 <span class="k">sub </span><span class="m">MaxRequestsPerChild ()</span> <span class="s">{</span> <span class="n">2</span> <span class="s">}</span>
  29 
  30 <span class="k">print</span> <span class="q">&quot;start prefork\n&quot;</span><span class="sc">;</span>
  31 <span class="k">my</span> <span class="i">$pm</span> = <span class="w">Parallel::Prefork</span><span class="w">-&gt;new</span><span class="s">(</span><span class="s">{</span>
  32     <span class="w">max_workers</span>  <span class="cm">=&gt;</span> <span class="n">3</span><span class="cm">,</span>
  33     <span class="w">fork_delay</span>   <span class="cm">=&gt;</span> <span class="n">1</span><span class="cm">,</span>
  34     <span class="w">trap_signals</span> <span class="cm">=&gt;</span> <span class="s">{</span>
  35         <span class="w">TERM</span> <span class="cm">=&gt;</span> <span class="q">&#39;TERM&#39;</span><span class="cm">,</span>
  36         <span class="w">HUP</span>  <span class="cm">=&gt;</span> <span class="q">&#39;TERM&#39;</span><span class="cm">,</span>
  37     <span class="s">}</span><span class="cm">,</span>
  38 <span class="s">}</span><span class="s">)</span><span class="sc">;</span>
  39 
  40 <span class="k">while</span> <span class="s">(</span><span class="i">$pm</span><span class="i">-&gt;signal_received</span> <span class="k">ne</span> <span class="q">&#39;TERM&#39;</span><span class="s">)</span> <span class="s">{</span>
  41     <span class="i">$pm</span><span class="i">-&gt;start</span> <span class="k">and</span> <span class="k">next</span><span class="sc">;</span>
  42     <span class="k">print</span> <span class="q">&quot;spawn $$\n&quot;</span><span class="sc">;</span>
  43 
  44     <span class="k">my</span> <span class="i">$client</span> = <span class="w">TheSchwartz::Moosified</span><span class="w">-&gt;new</span><span class="s">(</span> <span class="w">databases</span> <span class="cm">=&gt;</span> <span class="s">[</span><span class="i">$dbh</span><span class="s">]</span> <span class="s">)</span><span class="sc">;</span>
  45     <span class="i">$client</span><span class="i">-&gt;can_do</span><span class="s">(</span><span class="i">$_</span><span class="s">)</span> <span class="k">foreach</span> <span class="i">@wokers</span><span class="sc">;</span>
  46     
  47     <span class="k">my</span> <span class="i">$reqs_before_exit</span> = <span class="i">MaxRequestsPerChild</span><span class="sc">;</span>
  48     <span class="i">$SIG</span>{<span class="w">TERM</span>} = <span class="k">sub</span> <span class="s">{</span> <span class="i">$reqs_before_exit</span> = <span class="n">0</span> <span class="s">}</span><span class="sc">;</span>
  49     <span class="k">while</span> <span class="s">(</span><span class="i">$reqs_before_exit</span> &gt; <span class="n">0</span><span class="s">)</span> <span class="s">{</span>
  50         <span class="k">if</span> <span class="s">(</span><span class="i">$client</span><span class="i">-&gt;work_once</span><span class="s">)</span> <span class="s">{</span>
  51             <span class="k">print</span> <span class="q">&quot;work $$\n&quot;</span><span class="sc">;</span>
  52             --<span class="i">$reqs_before_exit</span><span class="sc">;</span>
  53         <span class="s">}</span> <span class="k">else</span> <span class="s">{</span>
  54             <span class="k">sleep</span> <span class="n">10</span><span class="sc">;</span>
  55         <span class="s">}</span>
  56     <span class="s">}</span>
  57 
  58     <span class="k">print</span> <span class="q">&quot;FINISHED $$\n&quot;</span><span class="sc">;</span>
  59     <span class="i">$pm</span><span class="i">-&gt;finish</span><span class="sc">;</span>
  60 <span class="s">}</span>
  61 
  62 
  63 <span class="i">$pm</span><span class="i">-&gt;wait_all_children</span><span class="sc">;</span>
  64 
  65 <span class="k">die</span> <span class="q">&quot;HMM????&quot;</span><span class="sc">;</span>
</pre>

<p>代码是自解释的。:)</p>
<p>但是有时候我们需要停止它的时候（它由 crontab 启动），根据代码我们需要发送 TERM 给脚本，然后脚本才会优雅地退出。这时候 <tt><a href="http://search.cpan.org/perldoc?Proc::ProcessTable">Proc::ProcessTable</a></tt> 就派上大用场了。</p>
<pre>
   1 <span class="k">use</span> <span class="w">Proc::ProcessTable</span><span class="sc">;</span>
   2 
   3 <span class="k">my</span> <span class="i">$p</span> = <span class="w">new</span> <span class="i">Proc::ProcessTable</span><span class="s">(</span> <span class="q">&#39;cache_ttys&#39;</span> <span class="cm">=&gt;</span> <span class="n">1</span> <span class="s">)</span><span class="sc">;</span>
   4 <span class="k">my</span> <span class="i">$all</span> = <span class="i">$p</span><span class="i">-&gt;table</span><span class="sc">;</span>
   5 <span class="k">foreach</span> <span class="k">my</span> <span class="i">$one</span> <span class="s">(</span><span class="i">@$all</span><span class="s">)</span> <span class="s">{</span>
   6     <span class="k">if</span> <span class="s">(</span><span class="i">$one</span><span class="i">-&gt;cmndline</span> =~ <span class="q">/TheSchwartz/</span><span class="s">)</span> <span class="s">{</span>
   7         <span class="k">next</span> <span class="k">if</span> <span class="s">(</span> <span class="i">$one</span><span class="i">-&gt;cmndline</span> =~ <span class="q">/TheSchwartz_restart/</span> <span class="s">)</span><span class="sc">;</span> <span class="c"># itself</span>
   8         <span class="k">my</span> <span class="i">$pid</span> = <span class="i">$one</span><span class="i">-&gt;pid</span><span class="sc">;</span>
   9         <span class="k">print</span> <span class="q">&quot;kill -15 $pid\n&quot;</span><span class="sc">;</span>
  10         <span class="q">`kill -15 $pid`</span><span class="sc">;</span> <span class="c"># send TERM</span>
  11     <span class="s">}</span>
  12 <span class="s">}</span>
</pre>

<p>Proc::ProcessTable 类似于 ps, 我们找到 pid 后，发送 TERM 过去就大功告成了。</p>
<p>谢谢。</p>
<div style="float: right; font-size: 10pt"><a href="ParallelSig.pod">View Source (POD)</a></div><br />
</body>
</html>
