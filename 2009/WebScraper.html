<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
   "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<!-- Generated by Pod::Advent 0.17 (Pod::Simple 3.10, Perl::Tidy 20090616) on 2009-12-06 19:42:52 -->
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<title>2009 Perl Advent Calendar: Web::Scraper 简介</title>
<link rel="stylesheet" href="../style.css" type="text/css" />
<link rel="alternate" type="text/plain" href="WebScraper.pod" />
</head>
<body>
<h1><a href="../">Perl Advent Calendar 2009-12</a>-06</h1>
<h2 align="center">Web::Scraper 简介</h2>
<h3 align="center">by cnhackTNT</h3>
<p>爬虫是一个非常有意思的话题。大家都知道在这个信息时代，数据就是宝藏，当你写好并部署完一批爬虫，然后敲下命令看着它们欢快而又卖力地去爬页面的时候，就像看到它们搬回了一堆堆的钻石原矿一样，绝对有快感的 --- 当然，咱说的是合法地抓取数据，而不是无耻地吸血 ^_^。</p>
<p>Web 发展之初，Perl 就得益于强大的文本处理能力而被用来编写各种各样的爬虫程序，今天这篇文章不会讨论真正的爬虫，因为这是一个非常复杂的系统，有非常多复杂的因素需要考虑，我们这篇文章将要说的是非常简单的从特定网页掘取你所需要的数据的方法, 而不是要实现一个完整而成熟的爬虫系统，当然对爬虫感兴趣的同学可以参看 CPAN 上的爬虫框架 <tt><a href="http://search.cpan.org/perldoc?Combine">Combine</a></tt>。</p>
<p>大部分的网页都是由一堆堆定义好的标签(Tag)和需要展示的内容所组成的, 这堆标签就是超文本标记语言（HTML/XHTML)，网页的作者提供内容，超文本标记语言负责告诉浏览器将这些内容渲染成丰富多彩的网页。超文本标记语言并不是为了用作数据交换而设计的，因此面对形形色色画里胡俏的网页，你要想写个程序把其中你感兴趣的内容抓出来还真是不容易，很传统的做法就是用 Perl 里的 <tt><a href="http://search.cpan.org/perldoc?LWP">LWP</a></tt> 模块把网页抓回来，然后用正则表达式去匹配出你想要的内容。但一旦碰到干扰因素很多的网页，用正则匹配的方式就很不方便了，挠破后脑勺也不一定能想出一句漂亮而优雅的正则表达式来实现你的目标。那有没有更方便的方式去定位某个 HTML 网页中的内容呢？</p>
<p>哈！当然有！知道 CSS，用过 <a href="http://www.jquery.com">jQuery</a> 的朋友肯定对其中无比方便的 CSS 选择子倾爱有加，这个东东用来定位 HTML 中的元素实在是太方便了，那我们在 Perl 中怎样能用这样的方式去解析并挖掘特定网页中的内容呢？答案就是 <a href="http://github.com/miyagawa">Miyagawa</a> 编写的 <tt><a href="http://search.cpan.org/perldoc?Web::Scraper">Web::Scraper</a></tt> 模块。</p>
<h3>安装 <tt>Web::Scraper</tt></h3>
<p>很简单：</p>
<pre><span class="c">$ sudo cpan Web::Scraper</span></pre>
<h3>任务</h3>
<p>让我们先设一个网页信息采集类的任务然后看看怎样用 <tt>Web::Scraper</tt> 来完成吧。</p>
<p>比如说我最近在做网络安全方面的分析，我需要收集最近的恶意软件，钓鱼或被挂马网站的域名列表，然后再进一步分析。那么我可能会去 <a href="http://www.malwareurl.com">Malwareurl.com</a> 网站的<a href="http://www.malwareurl.com/listing-urls.php">这个页面</a>收集它最近列出来的域名。页面中我们需要的信息以一个表格的方式呈现，看起来像这样：</p>
<p><img src="webscraper_sc1.jpg" /></p>
<p>我只需要表格中的第一个字段：<span style="font-weight: bold">Domain</span>。祭出 <a href="http://www.firefox.com">Firefox</a> 中的 <a href="http://getfirebug.com">Firebug</a> 插件，很容易获知，我们所需要的信息都在一个 id 为 <span style="font-weight: bold">tablesorterID</span> 的 <span style="font-weight: bold">table</span> 中，并且我想要收集的域名，就是这个表格主体内容 <span style="font-weight: bold">tbody</span> 的每一个 <span style="font-weight: bold">tr</span> 的第一个孩子元素 <span style="font-weight: bold">td</span> 的文本部分，看起来像这样：</p>
<p><img src="webscraper_sc2.jpg" /></p>
<p>那么我们的方法是这样：抓取<a href="http://www.malwareurl.com/listing-urls.php">这个页面</a>，然后将该页面交给 <tt>Web::Scraper</tt> 来处理，解析出我们想要的内容，然后以所需的格式组织好输出就大功告成了，简单吧。</p>
<h3>Web::Scraper 提供的方法</h3>
<p><tt>Web::Scraper</tt> 提供的方法很少很简单，就三个：<span style="font-weight: bold">scraper()</span>，<span style="font-weight: bold">scrape()</span>，<span style="font-weight: bold">process()</span>。</p>
<h4>scraper() 方法</h4>
<p>该方法负责按照你提供的参数来创建 <tt>Web::Scraper</tt> 对象，我们将会用这个对象来完成网页的解析。<tt>Web::Scraper</tt> 对象是可以嵌套的。相当于你列一张需要解析内容的单子。</p>
<h4>scrape() 方法</h4>
<p>这个方法告诉 <tt>Web::Scraper</tt> 对象从所给的网页(可以是 <tt><a href="http://search.cpan.org/perldoc?URI">URI</a></tt> 对象， <tt><a href="http://search.cpan.org/perldoc?HTML::Response">HTML::Response</a></tt> 对象，或者是字符串)中解析出你想要的内容。相当于你把这个单子交给具体的执行人，让他按照这个单子上规定的内容把东西取出来。</p>
<p>建议将 <tt>URI</tt> 或者 <tt><a href="http://search.cpan.org/perldoc?HTTP::Response">HTTP::Response</a></tt> 对象作为参数传给 scrape() 方法，这样的话它会自动根据 HTTP 的 <span style="font-style: italic">Content-Type</span> 头和网页中的 <span style="font-style: italic">Charset</span> 字段来解决编码的问题，如果你直接传给它字符串形式的网页内容，你就得自己处理编码的问题了。</p>
<h4>process() 方法</h4>
<p>这个方法非常重要，通过它，我们可以用 CSS 选择子或者 XPath 语句来定位网页中的元素，从而取得我们需要的部分内容。相当于那个单子上所列出的具体的一项项工作内容，它告诉 <tt>Web::Scraper</tt> 对象该在网页中什么位置，取什么样格式(TEXT，HTML 或者 XML)的内容出来。</p>
<h3>通过 process() 方法，用 CSS 选择子来标记我们需要的内容</h3>
<p>很简单，经过上面的分析，我们可以这样来表示我们所需要解析的域名信息：</p>
<pre>
    <span class="w">process</span> <span class="q">&quot;#tablesorterID &gt; tbody tr td:first-child&quot;</span><span class="cm">,</span> <span class="q">&quot;domains[]&quot;</span> <span class="cm">=&gt;</span> <span class="q">&quot;TEXT&quot;</span><span class="sc">;</span>
</pre>

<p>解释一下，上面语句的意思是：找到 id 为 <span style="font-weight: bold">tablesorterID</span> 的表格，接着找到这个表格中的主体部分 <span style="font-weight: bold">tbody</span>，取得这部分表格中所有的行 <span style="font-weight: bold">tr</span>，然后取出每行的第一个 <span style="font-weight: bold">td</span> 元素的文本内容，并把内容存到一个数组中，这个数组会被放到 <tt>Web::Scraper</tt> 对象调用 <span style="font-weight: bold">scrape</span> 方法后返回的哈希中，并且你可以用 <span style="font-weight: bold">domains</span> 作为 <span style="font-style: italic">key</span> 来从这个哈希中取到解析出的所有域名。</p>
<h3>构造一个 URI 对象</h3>
<p>很简单：</p>
<pre>
    <span class="w">URI</span><span class="w">-&gt;new</span><span class="s">(</span><span class="q">&quot;http://www.malwareurl.com/listing-urls.php&quot;</span><span class="s">)</span><span class="sc">;</span>
</pre>

<h3>组装代码</h3>
<p>我们把全部代码写出来：</p>
<pre>
#!/usr/bin/perl
<span class="c"># filename: malscraper.pl</span>

<span class="k">use</span> <span class="w">strict</span><span class="sc">;</span>
<span class="k">use</span> <span class="w">warnings</span><span class="sc">;</span>
<span class="k">use</span> <span class="w">URI</span><span class="sc">;</span>
<span class="k">use</span> <span class="w">Web::Scraper</span><span class="sc">;</span>

<span class="k">my</span> <span class="i">$url</span> = <span class="q">&quot;http://www.malwareurl.com/listing-urls.php&quot;</span><span class="sc">;</span>
<span class="k">my</span> <span class="i">$worker</span> = <span class="i">scraper</span> <span class="s">{</span>
    <span class="w">process</span> <span class="q">&quot;#tablesorterID &gt; tbody tr td:first-child&quot;</span><span class="cm">,</span> <span class="q">&quot;domains[]&quot;</span> <span class="cm">=&gt;</span> <span class="q">&quot;TEXT&quot;</span><span class="sc">;</span>
<span class="s">}</span><span class="sc">;</span>
<span class="k">print</span> <span class="q">&quot;Starting...\n&quot;</span><span class="sc">;</span>
<span class="k">my</span> <span class="i">$result</span> = <span class="i">$worker</span><span class="i">-&gt;scrape</span><span class="s">(</span> <span class="w">URI</span><span class="w">-&gt;new</span><span class="s">(</span><span class="i">$url</span><span class="s">)</span> <span class="s">)</span><span class="sc">;</span>

<span class="k">for</span> <span class="k">my</span> <span class="i">$domain</span> <span class="s">(</span> <span class="i">@</span>{ <span class="i">$result</span>-&gt;{<span class="w">domains</span>} } <span class="s">)</span> <span class="s">{</span>
    <span class="k">print</span> <span class="q">&quot;$domain\n&quot;</span><span class="sc">;</span>
<span class="s">}</span>
</pre>

<p>运行一下验证看看：</p>
<pre><span class="c">$ perl malscraper.pl
Starting...
mediadatastorage.net
multimediafact.com
armyprotection01.com
iwant2berich.cn
64.191.63.223
x000x.cn
91.213.126.93
print-design.cn
66.220.17.200
c24845.upd.host255-255-255-0.com
y7099.nb.host-domain-lookup.com
x2827.nb.host192-168-1-2.com
upd.netbios-wait.com
ciduninstall.com
movngs.cn
... 省略内容 ...</span></pre>
<p>瞧！很简单很方便不是？:-)</p>
<h3>增加需求</h3>
<p>OK，现在我们有新需求了，我需要抓取刚才那个表格中的 <span style="font-weight: bold">Domain</span>，<span style="font-weight: bold">IP</span> 和 <span style="font-weight: bold">Country</span> 字段，怎么办？没关系，先来分析一下：</p>
<p>表格中的每一行就是 <span style="font-weight: bold">tbody</span> 中 <span style="font-weight: bold">tr</span> 标签的内容，也就是一个个的 <span style="font-weight: bold">td</span> 块，我们需要这些 <span style="font-weight: bold">td</span> 标签中的 <span style="font-style: italic">TEXT</span> 内容（<span style="font-style: italic">Domain</span>，<span style="font-style: italic">IP</span>）以及那面小国旗图片的URL中代表国家的两个简写字母（比如 <a href="http://www.malwareurl.com/img/flags/CN.gif">http://www.malwareurl.com/img/flags/CN.gif</a> 中的 <span style="font-weight: bold">CN</span>）。</p>
<p>这样，解决方法就出来了，我们可以把 <span style="font-weight: bold">tr</span> 所有的内容抓出来，然后在这些内容中解析出每一个 <span style="font-weight: bold">td</span> 的文本部分以及代表 <span style="font-weight: bold">Country</span> 的图片地址。重新构造一下我们的 <span style="font-weight: bold">scraper()</span>：</p>
<pre>
<span class="i">scraper</span> <span class="s">{</span> 
    <span class="w">process</span> <span class="q">&quot;#tablesorterID &gt; tbody tr&quot;</span><span class="cm">,</span> <span class="q">&quot;rows[]&quot;</span> <span class="cm">=&gt;</span> <span class="i">scraper</span> <span class="s">{</span>
        <span class="w">process</span> <span class="q">&quot;td&quot;</span><span class="cm">,</span> <span class="q">&quot;cols[]&quot;</span> <span class="cm">=&gt;</span> <span class="q">&#39;TEXT&#39;</span><span class="sc">;</span>
        <span class="w">process</span> <span class="q">&quot;td &gt; div &gt; img&quot;</span><span class="cm">,</span>  <span class="w">country</span> <span class="cm">=&gt;</span> <span class="q">&#39;@src&#39;</span><span class="sc">;</span>
    <span class="s">}</span><span class="sc">;</span>
<span class="s">}</span><span class="sc">;</span>
</pre>

<p>解释一下，上面我们使用了嵌套的 <span style="font-weight: bold">scraper</span>，这是啥意思呢？第一个 <span style="font-weight: bold">scraper</span>，我们先找到 id 为 <span style="font-weight: bold">tablesorterID</span> 的表格，然后找到它的主体部分 <span style="font-weight: bold">tbody</span>，并将 <span style="font-weight: bold">tbody</span> 中代表表格每一行的 <span style="font-weight: bold">tr</span> 解析出来丢给那个嵌套的 <span style="font-weight: bold">scraper</span>，在嵌套的 <span style="font-weight: bold">scraper</span> 中，我们再对 <span style="font-weight: bold">tr</span> 这一行进行解析，取出这一行所有的字段，也就是所有的 <span style="font-weight: bold">td</span> 标签的文本部分，存到一个数组里，这个数组会被作为一个数组引用保存在一个结果哈希中，其 <span style="font-style: italic">key</span> 就是 <span style="font-weight: bold">cols</span>。同时，我们还取出每一行中唯一的图片URL，以 <span style="font-weight: bold">country</span> 为 <span style="font-style: italic">key</span>， 也保存在结果哈希中。</p>
<p>此时，结果 <span style="font-weight: bold">$result</span> 看起来像：</p>
<pre>
<span class="i">$result</span>-&gt;{<span class="w">rows</span>} = <span class="s">[</span>
          <span class="s">{</span>
            <span class="q">&#39;country&#39;</span> <span class="cm">=&gt;</span> <span class="k">bless</span><span class="s">(</span> <span class="k">do</span><span class="s">{</span>\<span class="s">(</span><span class="k">my</span> <span class="i">$o</span> = <span class="q">&#39;http://www.malwareurl.com/img/flags/US.gif&#39;</span><span class="s">)</span><span class="s">}</span><span class="cm">,</span> <span class="q">&#39;URI::http&#39;</span> <span class="s">)</span><span class="cm">,</span>
            <span class="q">&#39;cols&#39;</span> <span class="cm">=&gt;</span> <span class="s">[</span>
                        <span class="q">&#39;mediadatastorage.net&#39;</span><span class="cm">,</span>
                        <span class="q">&quot;69.10.41.147\x{a0}&quot;</span><span class="cm">,</span>
                        <span class="q">&quot;reverse41-146.reserver.ru\x{a0}&quot;</span><span class="cm">,</span>
                        <span class="q">&quot;AS19318 (NJIIX) \x{a0}&quot;</span><span class="cm">,</span>
                        <span class="q">&quot;Fast Flux Trojan\x{a0}&quot;</span><span class="cm">,</span>
                        <span class="q">&quot;Patrick F Godwin / patrickf\@loveable.com\x{a0}&quot;</span><span class="cm">,</span>
                        <span class="q">&quot;\x{a0}&quot;</span><span class="cm">,</span>
                        <span class="q">&quot;2009-12-05\x{a0}&quot;</span><span class="cm">,</span>
                        <span class="q">&#39;details&#39;</span>
                      <span class="s">]</span>
          <span class="s">}</span><span class="cm">,</span>
          <span class="s">{</span>
            <span class="q">&#39;country&#39;</span> <span class="cm">=&gt;</span> <span class="k">bless</span><span class="s">(</span> <span class="k">do</span><span class="s">{</span>\<span class="s">(</span><span class="k">my</span> <span class="i">$o</span> = <span class="q">&#39;http://www.malwareurl.com/img/flags/US.gif&#39;</span><span class="s">)</span><span class="s">}</span><span class="cm">,</span> <span class="q">&#39;URI::http&#39;</span> <span class="s">)</span><span class="cm">,</span>
            <span class="q">&#39;cols&#39;</span> <span class="cm">=&gt;</span> <span class="s">[</span>
                        <span class="q">&#39;multimediafact.com&#39;</span><span class="cm">,</span>
                        <span class="q">&quot;69.10.41.147\x{a0}&quot;</span><span class="cm">,</span>
                        <span class="q">&quot;reverse41-146.reserver.ru\x{a0}&quot;</span><span class="cm">,</span>
                        <span class="q">&quot;AS19318 (NJIIX) \x{a0}&quot;</span><span class="cm">,</span>
                        <span class="q">&quot;Fast Flux Trojan\x{a0}&quot;</span><span class="cm">,</span>
                        <span class="q">&quot;Patrick F Godwin / patrickf\@loveable.com\x{a0}&quot;</span><span class="cm">,</span>
                        <span class="q">&quot;\x{a0}&quot;</span><span class="cm">,</span>
                        <span class="q">&quot;2009-12-05\x{a0}&quot;</span><span class="cm">,</span>
                        <span class="q">&#39;details&#39;</span>
                      <span class="s">]</span>
          <span class="s">}</span><span class="cm">,</span>

<span class="c"># ... omit the rest part of codes ...</span>
</pre>

<p>于是，整个结构就很清晰了，只需要对结果集做一些处理便可以满足我们的需求了。</p>
<p>完整代码：</p>
<pre>
#!/usr/bin/perl
<span class="c"># filename: malscraper.pl</span>

<span class="k">use</span> <span class="w">strict</span><span class="sc">;</span>
<span class="k">use</span> <span class="w">warnings</span><span class="sc">;</span>
<span class="k">use</span> <span class="w">URI</span><span class="sc">;</span>
<span class="k">use</span> <span class="w">Web::Scraper</span><span class="sc">;</span>

<span class="k">my</span> <span class="i">$url</span> = <span class="q">&quot;http://www.malwareurl.com/listing-urls.php&quot;</span><span class="sc">;</span>
<span class="k">my</span> <span class="i">$worker</span> = <span class="i">scraper</span> <span class="s">{</span>
    <span class="w">process</span> <span class="q">&quot;#tablesorterID &gt; tbody tr&quot;</span><span class="cm">,</span> <span class="q">&quot;rows[]&quot;</span> <span class="cm">=&gt;</span> <span class="i">scraper</span> <span class="s">{</span>
        <span class="w">process</span> <span class="q">&quot;td&quot;</span><span class="cm">,</span> <span class="q">&quot;cols[]&quot;</span> <span class="cm">=&gt;</span> <span class="q">&#39;TEXT&#39;</span><span class="sc">;</span>
        <span class="w">process</span> <span class="q">&quot;td &gt; div &gt; img&quot;</span><span class="cm">,</span>  <span class="w">country</span> <span class="cm">=&gt;</span> <span class="q">&#39;@src&#39;</span><span class="sc">;</span>
    <span class="s">}</span><span class="sc">;</span>
<span class="s">}</span><span class="sc">;</span>
<span class="k">print</span> <span class="q">&quot;Starting...\n&quot;</span><span class="sc">;</span>
<span class="k">my</span> <span class="i">$result</span> = <span class="i">$worker</span><span class="i">-&gt;scrape</span><span class="s">(</span> <span class="w">URI</span><span class="w">-&gt;new</span><span class="s">(</span><span class="i">$url</span><span class="s">)</span> <span class="s">)</span><span class="sc">;</span>

<span class="k">printf</span> <span class="q">&quot;%-50s \| %-15s \| %-2s\n&quot;</span><span class="cm">,</span> <span class="q">&quot;Domain&quot;</span><span class="cm">,</span> <span class="q">&quot;IP&quot;</span><span class="cm">,</span> <span class="q">&quot;Country&quot;</span><span class="sc">;</span>
<span class="k">print</span> <span class="q">&quot;-&quot;</span><span class="n">x80</span><span class="cm">,</span> <span class="q">&quot;\n&quot;</span><span class="sc">;</span>
<span class="k">for</span> <span class="k">my</span> <span class="i">$row</span> <span class="s">(</span> <span class="i">@</span>{ <span class="i">$result</span>-&gt;{<span class="w">rows</span>} } <span class="s">)</span> <span class="s">{</span>
    <span class="k">my</span> <span class="s">(</span><span class="i">$domain</span><span class="cm">,</span> <span class="i">$ip</span><span class="s">)</span> = <span class="i">@</span>{ <span class="i">$row</span>-&gt;{<span class="w">cols</span>} }[<span class="n">0</span><span class="cm">,</span><span class="n">1</span>]<span class="sc">;</span>
    <span class="k">my</span> <span class="s">(</span><span class="i">$country</span><span class="s">)</span> = <span class="i">$row</span>-&gt;{<span class="w">country</span>} =~ <span class="q">/\/(\w+)\.gif$/</span><span class="sc">;</span>
    <span class="i">$ip</span> =~ <span class="q">s/\xA0$//</span><span class="sc">;</span> <span class="c"># truncate &quot;\xA0&quot; at the end</span>
    <span class="k">printf</span> <span class="q">&quot;%-50s \| %15s \| %-2s\n&quot;</span><span class="cm">,</span> <span class="i">$domain</span><span class="cm">,</span> <span class="i">$ip</span><span class="cm">,</span> <span class="i">$country</span><span class="sc">;</span>
<span class="s">}</span>
</pre>

<p>运行一下看看效果:</p>
<pre><span class="c">$ perl malscraper.pl 
Starting...
Domain                                             | IP              | Country
--------------------------------------------------------------------------------
mediadatastorage.net                               |    69.10.41.147 | US
multimediafact.com                                 |    69.10.41.147 | US
armyprotection01.com                               |   88.198.160.57 | DE
iwant2berich.cn                                    |   64.191.63.233 | US
64.191.63.223                                      |   64.191.63.223 | US
x000x.cn                                           |  210.51.166.119 | CN
91.213.126.93                                      |   91.213.126.93 | UA
print-design.cn                                    |   193.104.22.20 | UA
66.220.17.200                                      |   66.220.17.200 | US
c24845.upd.host255-255-255-0.com                   |   66.220.17.200 | US
y7099.nb.host-domain-lookup.com                    |   66.220.17.200 | US
x2827.nb.host192-168-1-2.com                       |   66.220.17.200 | US
upd.netbios-wait.com                               |   66.220.17.200 | US
ciduninstall.com                                   |   66.220.17.200 | US
movngs.cn                                          |  210.51.166.241 | CN

... 省略结果 ...</span></pre>
<p>哦耶！很 Cool！</p>
<h3>疑问：谁帮我抓的网页内容？</h3>
<p>好问题！<tt>Web::Scraper</tt> 有用到 <tt><a href="http://search.cpan.org/perldoc?LWP::UserAgent">LWP::UserAgent</a></tt>，如果你给 <span style="font-weight: bold">scrape</span> 方法的参数是一个 <tt>URI</tt> 对象，那么 <tt>Web::Scraper</tt> 内部会把参数传给 <tt>LWP::UserAgent</tt> 叫它去抓网页，然后返回一个 <tt>HTTP::Response</tt> 对象再进行下一步处理。</p>
<p><tt>Web::Scraper</tt> 模块本身不是一个特别复杂的模块，你可以查看它的源码以获取更多的细节。</p>
<p>如果有任何问题，请来 <a href="http://groups.google.com/group/perlchina">Perlchina 的邮件 列表</a>询问。（或发送任意邮件到 <span style="font-weight: bold">perlchina+subscribe@googlegroups.com</span> 申请加入列 表）</p>
<p>Enjoy！</p>
<div style="float: right; font-size: 10pt"><a href="WebScraper.pod">View Source (POD)</a></div><br />
</body>
</html>
