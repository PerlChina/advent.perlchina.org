<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
   "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<!-- Generated by Pod::Advent 0.17 (Pod::Simple 3.07, Perl::Tidy 20071205) on 2009-12-04 09:14:54 -->
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="content-type" content="text/html; charset=utf-8" />
<title>2009 CN Perl Advent Calendar: autodie</title>
<link rel="stylesheet" href="../style.css" type="text/css" />
<link rel="alternate" type="text/plain" href="autodie.pod" />
</head>
<body>
<h1><a href="index.html">CN Perl Advent Calendar 2009-12</a>-04</h1>
<h2 align="center">autodie</h2>
<h3 align="center">by Fayland Lam</h3>
<p>在编写 Perl 脚本的时候，我们经常使用类似下面的代码来检查内置函数（如 open）是否成功。</p>
<pre>
<span class="k">open</span><span class="s">(</span><span class="k">my</span> <span class="i">$fh</span><span class="cm">,</span> <span class="q">&#39;&lt;&#39;</span><span class="cm">,</span> <span class="i">$filename</span><span class="s">)</span> <span class="k">or</span> <span class="k">die</span> <span class="q">&quot;Can&#39;t open $filename - $!&quot;</span><span class="sc">;</span>
</pre>

<p>我们经常发现有太多地方需要重复写，或者经常遗忘了这样写。想偷懒？找 <a href="autodie">autodie</a>.</p>
<pre>
   1 <span class="k">eval</span> <span class="s">{</span>
   2     <span class="k">use</span> <span class="w">autodie</span><span class="sc">;</span>
   3     <span class="k">open</span><span class="s">(</span><span class="k">my</span> <span class="i">$fh</span><span class="cm">,</span> <span class="q">&#39;&lt;&#39;</span><span class="cm">,</span> <span class="i">$some_file</span><span class="s">)</span><span class="sc">;</span>
   4     <span class="k">my</span> <span class="i">@records</span> = <span class="q">&lt;$fh&gt;</span><span class="sc">;</span>
   5     <span class="c"># Do things with @records...</span>
   6     <span class="k">close</span><span class="s">(</span><span class="i">$fh</span><span class="s">)</span><span class="sc">;</span>
   7 <span class="s">}</span><span class="sc">;</span>
   8 
   9 <span class="k">if</span> <span class="s">(</span><span class="i">$@</span> <span class="k">and</span> <span class="i">$@</span><span class="i">-&gt;isa</span><span class="s">(</span><span class="q">&#39;autodie::exception&#39;</span><span class="s">)</span><span class="s">)</span> <span class="s">{</span>
  10     <span class="k">if</span> <span class="s">(</span><span class="i">$@</span><span class="i">-&gt;matches</span><span class="s">(</span><span class="q">&#39;open&#39;</span><span class="s">)</span><span class="s">)</span> <span class="s">{</span> <span class="k">print</span> <span class="q">&quot;Error from open\n&quot;</span><span class="sc">;</span>   <span class="s">}</span>
  11     <span class="k">if</span> <span class="s">(</span><span class="i">$@</span><span class="i">-&gt;matches</span><span class="s">(</span><span class="q">&#39;:io&#39;</span> <span class="s">)</span><span class="s">)</span> <span class="s">{</span> <span class="k">print</span> <span class="q">&quot;Non-open, IO error.&quot;</span><span class="sc">;</span> <span class="s">}</span>
  12 <span class="s">}</span> <span class="k">elsif</span> <span class="s">(</span><span class="i">$@</span><span class="s">)</span> <span class="s">{</span>
  13     <span class="c"># A non-autodie exception.</span>
  14 <span class="s">}</span>
</pre>

<p>autodie 不仅仅对系统函数起作用，还可以对自定义函数其作用。</p>
<pre>
<span class="k">use</span> <span class="w">File::Copy</span> <span class="q">qw(move)</span><span class="sc">;</span>
<span class="k">use</span> <span class="w">autodie</span> <span class="q">qw(move)</span><span class="sc">;</span>

<span class="i">move</span><span class="s">(</span><span class="q">&#39;noexists.txt&#39;</span><span class="cm">,</span> <span class="q">&#39;another.txt&#39;</span><span class="s">)</span><span class="sc">;</span>
</pre>

<p>当移动失败时会自动报错，如</p>
<pre><span class="c">Can't move('noexists.txt', 'another.txt'): Bad file descriptor at t.pl line 9</span></pre>
<p>更多的请参考 <a href="autodie">autodie</a> doc 和 <a href="http://perltraining.com.au/tips/2008-08-20.html">Perl Training Australia - autodie</a></p>
<p>谢谢。</p>
<div style="float: right; font-size: 10pt"><a href="autodie.pod">View Source (POD)</a></div><br />
</body>
</html>
