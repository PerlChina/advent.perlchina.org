<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
   "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<!-- Generated by Pod::Advent 0.18 (Pod::Simple 3.07, Perl::Tidy 20071205) on 2009-12-22 21:39:23 -->
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="content-type" content="text/html; charset=utf-8" />
<title>2009 CN Perl Advent Calendar: LWP::UserAgent</title>
<link rel="stylesheet" href="../style.css" type="text/css" />
<link rel="alternate" type="text/plain" href="LWP_UserAgent.pod" />
</head>
<body>
<h1><a href="../">CN Perl Advent Calendar 2009-12</a>-22</h1>
<h2 align="center">LWP::UserAgent</h2>
<h3 align="center">by Fayland Lam</h3>
<p><tt><a href="http://search.cpan.org/perldoc?LWP::UserAgent">LWP::UserAgent</a></tt> 应该是个大家都很熟悉的模块，做 scraper 所不可缺少的。</p>
<p>如下的 tip 可能对您所有帮助。因为 <tt><a href="http://search.cpan.org/perldoc?WWW::Mechanize">WWW::Mechanize</a></tt> 是其子类，所以下面的东西 WWW::Mechanize 也是可以使用的。</p>
<p>agent 是浏览器的一个代号，默认 LWP::UserAgent 会把 "libwww-perl/$LWP::VERSION" 当作自己的 agent。而如果某些网站需要一些流行的浏览器版本时（如 Facebook），那我们可以传递浏览器的代号进去。</p>
<pre>
<span class="k">my</span> <span class="i">$ua</span> = <span class="w">LWP::UserAgent</span><span class="w">-&gt;new</span><span class="s">(</span>
    <span class="w">agent</span>       <span class="cm">=&gt;</span> <span class="q">&#39;Mozilla/5.0 (Windows; U; Windows NT 5.1; en-US; rv:1.9.1.6) Gecko/20091201 Firefox/3.5.6&#39;</span><span class="cm">,</span>
<span class="s">)</span><span class="sc">;</span>
</pre>

<p>如果有些网站是 Mobile 类型的，可以传递 iPhone 或其他的 agent 进去</p>
<pre>
<span class="k">my</span> <span class="i">$ua</span> = <span class="w">LWP::UserAgent</span><span class="w">-&gt;new</span><span class="s">(</span>
    <span class="w">agent</span>       <span class="cm">=&gt;</span> <span class="q">&#39;Mozilla/5.0 (iPhone; U; CPU iPhone OS 3_0 like Mac OS X; en-us) AppleWebKit/528.18 (KHTML, like Gecko) Version/4.0 Mobile/7A341 Safari/528.16&#39;</span><span class="cm">,</span> <span class="c"># iPhone 3.0</span>
<span class="s">)</span><span class="sc">;</span>
</pre>

<p>更多的类型可以参考 <tt><a href="http://search.cpan.org/perldoc?HTTP::BrowserDetect">HTTP::BrowserDetect</a></tt></p>
<p>默认的 LWP::UserAgent 不开启 cookie, 一般需要登录的网站都需要 cookies，最常见的做法是传递一个 {} 给 cookie_jar</p>
<pre>
<span class="k">my</span> <span class="i">$ua</span> = <span class="w">LWP::UserAgent</span><span class="w">-&gt;new</span><span class="s">(</span>
    <span class="w">agent</span>       <span class="cm">=&gt;</span> <span class="q">&#39;Mozilla/5.0 (Windows; U; Windows NT 5.1; en-US; rv:1.9.1.6) Gecko/20091201 Firefox/3.5.6&#39;</span><span class="cm">,</span>
    <span class="w">cookie_jar</span>  <span class="cm">=&gt;</span> <span class="s">{</span><span class="s">}</span><span class="cm">,</span>
<span class="s">)</span><span class="sc">;</span>
</pre>

<p>这样会自动创建一个基于内存的 <tt><a href="http://search.cpan.org/perldoc?HTTP::Cookies">HTTP::Cookies</a></tt>, 如果你知道您的 cookie 所在（比如通过验证码后的 Cookies 文件），可以传递一个 hash 或者 <tt>HTTP::Cookies</tt> 的实例</p>
<pre>
<span class="k">my</span> <span class="i">$ua</span> = <span class="w">LWP::UserAgent</span><span class="w">-&gt;new</span><span class="s">(</span>
    <span class="w">agent</span>       <span class="cm">=&gt;</span> <span class="q">&#39;Mozilla/5.0 (Windows; U; Windows NT 5.1; en-US; rv:1.9.1.6) Gecko/20091201 Firefox/3.5.6&#39;</span><span class="cm">,</span>
    <span class="w">cookie_jar</span>  <span class="cm">=&gt;</span> <span class="s">{</span> <span class="w">file</span> <span class="cm">=&gt;</span> <span class="q">&quot;$ENV{HOME}/.cookies.txt&quot;</span> <span class="s">}</span><span class="cm">,</span>
    <span class="c"># or</span>
    <span class="c"># use HTTP::Cookies;</span>
    <span class="c"># cookie_jar =&gt; HTTP::Cookies-&gt;new( file =&gt; &quot;$ENV{HOME}/.cookies.txt&quot; ),</span>
<span class="s">)</span><span class="sc">;</span>
</pre>

<p>我们一般通过 <tt><a href="http://search.cpan.org/perldoc?Crypt::SSLeay">Crypt::SSLeay</a></tt> 来访问 https 网站，所以一般都需要安装此模块（Win32 下建议 ppm install Crypt::SSLeay）。</p>
<p>最后我们讲讲 Proxy.</p>
<p>Proxy 的使用有两种，一种是代码里直接设置，另一种是通过 ENV 设置。</p>
<pre>
<span class="i">$ua</span><span class="i">-&gt;proxy</span><span class="s">(</span><span class="q">&#39;http&#39;</span><span class="cm">,</span> <span class="q">&#39;http://user:pass@example.com:9090&#39;</span><span class="s">)</span><span class="sc">;</span>
<span class="i">$ua</span><span class="i">-&gt;proxy</span><span class="s">(</span> <span class="s">[</span><span class="q">&#39;http&#39;</span><span class="cm">,</span> <span class="q">&#39;https&#39;</span><span class="s">]</span><span class="cm">,</span> <span class="q">&#39;https://user:pass@127.0.0.1/&#39;</span> <span class="s">)</span><span class="sc">;</span>

<span class="i">$ua</span><span class="i">-&gt;env_proxy</span><span class="sc">;</span>
</pre>

<p>env_proxy 的使用请参见 <tt>LWP::UserAgent</tt> 文档。</p>
<p>有时候可能有 socks5 proxy，这时候需要额外安装 <tt><a href="http://search.cpan.org/perldoc?LWP::Protocol::http::socks">LWP::Protocol::http::socks</a></tt>, socks 的 proxy URL 写法如同 http:// 例子如 socks://127.0.0.1:7070/</p>
<p>如果在 proxy 失败之后想去掉 proxy, $ua->no_proxy($domain) 是一种写法，另一种更简单的 hack 方法是</p>
<pre>
<span class="i">$ua</span>-&gt;{<span class="w">proxy</span>} = <span class="s">{</span><span class="s">}</span><span class="sc">;</span>
</pre>

<p>如果有任何问题，请来 <a href="http://groups.google.com/group/perlchina">Perlchina 的邮件列表</a>询问。（或发送任意邮件到 <span style="font-weight: bold">perlchina+subscribe@googlegroups.com</span> 申请加入列表）</p>
<p>谢谢。</p>
<div style="float: right; font-size: 10pt"><a href="LWP_UserAgent.pod">View Source (POD)</a></div><br />
</body>
</html>
