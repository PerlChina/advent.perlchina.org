<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
   "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<!-- Generated by Pod::Advent 0.24 (Pod::Simple 3.07, Perl::Tidy 20101217) on 2011-12-10 07:31:59 -->
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<title>2011 Perl Advent Calendar: Exporter::Auto</title>
<meta http-equiv="content-type" content="text/html; charset=utf-8" />
<link rel="stylesheet" href="../style.css" type="text/css" />
<link rel="alternate" type="text/plain" href="Exporter_Auto.pod" />
</head>
<body>
<h1><a href="../">Perl Advent Calendar 2011-12</a>-10</h1>
<h2 align="center">Exporter::Auto</h2>
<h3 align="center">by Fayland Lam</h3>
<p><tt><a href="http://search.cpan.org/perldoc?Exporter::Auto" title="Exporter::Auto">Exporter::Auto</a></tt> 是 <tt><a href="http://search.cpan.org/perldoc?Exporter" title="Exporter">Exporter</a></tt> 的 enhanced 版本。它默认将您代码里的 subs 导入到 @EXPORT 里，免去了您在 @EXPORT 里人工添加和删除 sub 的烦恼。</p>
<p>该模块今天新鲜出炉，功能方便有某些缺陷，比如您不能控制弄到 @EXPORT_OK （有兴趣的童鞋可以给作者发送 patch, 通过传递 import 参数来配置），比如您不能将 $, @, % 自动或者额外加到 @EXPORT 里，但是该模块还是非常方便的完成了一个既定的任务，将所有的 subs 自动导出。</p>
<p>尤其是代码非常简洁优雅，所以想和诸位共享一下。（中文注释是本人添加）</p>
<pre>
<a name="package-Exporter::Auto"></a>   1 <span class="k">package </span><span class="i">Exporter::Auto</span><span class="sc">;</span>
   2 <span class="k">use</span> <span class="w">strict</span><span class="sc">;</span>
   3 <span class="k">use</span> <span class="w">warnings</span><span class="sc">;</span>
   4 <span class="k">use</span> <span class="n">5.008005</span><span class="sc">;</span>
   5 <span class="k">our</span> <span class="i">$VERSION</span> = <span class="q">&#39;0.01&#39;</span><span class="sc">;</span>
   6 
   7 <span class="k">use</span> <span class="w">Sub::Identify</span> <span class="q">qw(stash_name)</span><span class="sc">;</span>
   8 <span class="k">use</span> <span class="w">B::Hooks::EndOfScope</span><span class="sc">;</span>
   9 <span class="k">use</span> <span class="w">Exporter</span><span class="sc">;</span> <span class="c"># &egrave;&macr;&yen;&egrave;&iexcl;&#140;&aring;&sup1;&para;&aelig;&#151;&nbsp;&aring;&iquest;&#133;&egrave;&brvbar;&#129;</span>
  10 
<a name="import"></a>  11 <span class="k">sub </span><span class="m">import</span> <span class="s">{</span>
  12     <span class="k">my</span> <span class="i">$klass</span> = <span class="k">caller</span><span class="s">(</span><span class="n">0</span><span class="s">)</span><span class="sc">;</span> <span class="c"># &aring;&frac34;&#151;&aring;&#136;&deg;&egrave;&macr;&yen;&egrave;&deg;&#131;&ccedil;&#148;&uml;&aelig;&uml;&iexcl;&aring;&#157;&#151;&ccedil;&#154;&#132;&aring;&#144;&#141;&aring;&shy;&#151;</span>
  13 
  14     <span class="k">no</span> <span class="w">strict</span> <span class="q">&#39;refs&#39;</span><span class="sc">;</span>
  15     <span class="k">unshift</span> <span class="i">@</span>{<span class="q">&quot;${klass}::ISA&quot;</span>}<span class="cm">,</span> <span class="q">&#39;Exporter&#39;</span><span class="sc">;</span> <span class="c"># &aring;&deg;&#134; Exporter &aring;&frac12;&#147;&aelig;&#136;&#144;&ccedil;&#155;&reg;&aelig;&nbsp;&#135;&aelig;&uml;&iexcl;&aring;&#157;&#151;&ccedil;&#154;&#132;&ccedil;&#136;&para;&ccedil;&plusmn;&raquo;</span>
  16 
  17     <span class="i">on_scope_end</span> <span class="s">{</span> <span class="c"># &aring;&#156;&uml;&ccedil;&frac14;&#150;&egrave;&macr;&#145;&egrave;&macr;&yen;&aring;&#157;&#151;&auml;&raquo;&pound;&ccedil;&nbsp;&#129;&ccedil;&raquo;&#147;&aelig;&#157;&#159;&eacute;&copy;&not;&auml;&cedil;&#138;&egrave;&iquest;&#144;&egrave;&iexcl;&#140;&iuml;&frac14;&#140;&aring;&#155;&nbsp;&auml;&cedil;&ordm;&aring;&#156;&uml; runtime &aelig;&#151;&para;&auml;&frac14;&#154;&aelig;&#151;&nbsp;&aelig;&#149;&#136;</span>
  18         <span class="k">while</span> <span class="s">(</span><span class="k">my</span> <span class="s">(</span><span class="i">$k</span><span class="cm">,</span> <span class="i">$v</span><span class="s">)</span> = <span class="k">each</span> <span class="i">%</span>{<span class="q">&quot;${klass}::&quot;</span>}<span class="s">)</span> <span class="s">{</span>
  19             <span class="k">next</span> <span class="k">if</span> <span class="i">$k</span> =~ <span class="q">/^(?:BEGIN|CHECK|END)$/</span><span class="sc">;</span> <span class="c"># &egrave;&middot;&sup3;&egrave;&iquest;&#135;&auml;&cedil;&#128;&auml;&ordm;&#155; Perl &egrave;&#135;&ordf;&aring;&cedil;&brvbar;&ccedil;&#154;&#132; sub, &aring;&#155;&nbsp;&auml;&cedil;&ordm;&eacute;&#131;&frac12;&aelig;&sup2;&iexcl;&aring;&iquest;&#133;&egrave;&brvbar;&#129;&aring;&macr;&frac14;&aring;&#133;&yen;&atilde;&#128;&#130;&aring;&#143;&macr;&egrave;&#131;&frac12;&eacute;&#156;&#128;&egrave;&brvbar;&#129;&aelig;&#155;&acute;&aring;&curren;&#154;&ccedil;&#154;&#132;&aring;&brvbar;&#130; INIT, DESTORY, AUTOLOAD &ccedil;&shy;&#137;&atilde;&#128;&#130;</span>
  20             <span class="k">next</span> <span class="k">if</span> <span class="i">$k</span> =~ <span class="q">/^_/</span><span class="sc">;</span> <span class="c"># &auml;&cedil;&#141;&aring;&macr;&frac14;&aring;&#133;&yen;&ccedil;&sect;&#129;&aelig;&#156;&#137;&aring;&#135;&frac12;&aelig;&#149;&deg;</span>
  21             <span class="k">next</span> <span class="k">unless</span> <span class="i">*</span>{<span class="q">&quot;${klass}::${k}&quot;</span>}{<span class="w">CODE</span>}<span class="sc">;</span> <span class="c"># &aring;&#143;&ordf;&aring;&macr;&frac14;&aring;&#133;&yen;&auml;&raquo;&pound;&ccedil;&nbsp;&#129;&iuml;&frac14;&#140;&auml;&cedil;&#141;&aring;&macr;&frac14;&aring;&#133;&yen; scalar, array, hash &ccedil;&shy;&#137;</span>
  22             <span class="k">next</span> <span class="k">if</span> <span class="i">$klass</span> <span class="k">ne</span> <span class="i">stash_name</span><span class="s">(</span><span class="i">$klass</span><span class="i">-&gt;can</span><span class="s">(</span><span class="i">$k</span><span class="s">)</span><span class="s">)</span><span class="sc">;</span> <span class="c"># &aring;&#143;&ordf;&aring;&macr;&frac14;&aring;&#133;&yen;&aring;&plusmn;&#158;&auml;&ordm;&#142;&egrave;&deg;&#131;&ccedil;&#148;&uml;&aelig;&uml;&iexcl;&aring;&#157;&#151;&ccedil;&#154;&#132;&iuml;&frac14;&#140;&egrave;&#128;&#140;&eacute;&#157;&#158;&egrave;&deg;&#131;&ccedil;&#148;&uml;&aelig;&uml;&iexcl;&aring;&#157;&#151;&aelig;&#137;&#128;&aring;&macr;&frac14;&aring;&#133;&yen;&ccedil;&#154;&#132;&eacute;&cent;&#157;&aring;&curren;&#150;sub</span>
  23             <span class="k">push</span> <span class="i">@</span>{<span class="q">&quot;${klass}::EXPORT&quot;</span>}<span class="cm">,</span> <span class="i">$k</span><span class="sc">;</span> <span class="c"># &aelig;&middot;&raquo;&aring;&#138;&nbsp;&aring;&#136;&deg; @EXPORT</span>
  24         <span class="s">}</span>
  25     <span class="s">}</span><span class="sc">;</span>
  26 <span class="s">}</span>
  27 
  28 
  29 <span class="n">1</span><span class="sc">;</span>
<a name="__END__"></a>  30 <span class="k">__END__</span>
</pre>

<p>非常简洁优雅。use Exporter::Auto; 就等同于 unshift @MYCLASS::ISA, 'Exporter'; @MYCLASS::EXPORT = ('all-my-subs');</p>
<p>每一行都起作用，又能非常完美地完成既定任务。多阅读阅读类似的代码，对 Perl 的学习提升非常有帮助。</p>
<p>PS，阅读模块的代码别忘了阅读模块的 .t 文件。</p>
<p>谢谢。</p>
<div style="float: right; font-size: 10pt"><a href="Exporter_Auto.pod">View Source (POD)</a></div><br />
</body>
</html>
