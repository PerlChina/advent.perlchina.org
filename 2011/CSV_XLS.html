<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
   "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<!-- Generated by Pod::Advent 0.24 (Pod::Simple 3.13, Perl::Tidy 20101217) on 2011-12-14 22:11:12 -->
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<title>2011 Perl Advent Calendar: CSV & XLS</title>
<meta http-equiv="content-type" content="text/html; charset=utf-8" />
<link rel="stylesheet" href="../style.css" type="text/css" />
<link rel="alternate" type="text/plain" href="CSV_XLS.pod" />
</head>
<body>
<h1><a href="../">Perl Advent Calendar 2011-12</a>-14</h1>
<h2 align="center">CSV & XLS</h2>
<h3 align="center">by Fayland Lam</h3>
<p>Well, 很多人都喜欢用 Excel or OpenOffice Calc 来打开表格文件。所以您的上司，客户或者朋友，会让你输出 csv 或者 xls 给他们。</p>
<p>有些人喜欢直接用 print join(', ', map { '"' . $_ . '"' } @outs) 来输出成 CSV, 但是这是极度不好的行为，因为 outs 里可能有 " 也可能有 ,</p>
<p>所以个人建议，不管是解析 CSV 或者构造 CSV, 都应该使用标准的 CPAN 模块。如 <tt><a href="http://search.cpan.org/perldoc?Text::CSV_XS" title="Text::CSV_XS">Text::CSV_XS</a></tt></p>
<pre>
<span class="k">use</span> <span class="w">Data::Dumper</span><span class="sc">;</span>
<span class="k">use</span> <span class="w">Text::CSV_XS</span><span class="sc">;</span>
<span class="k">my</span> <span class="i">$csv</span> = <span class="w">Text::CSV_XS</span><span class="w">-&gt;new</span> <span class="s">(</span><span class="s">{</span> <span class="w">binary</span> <span class="cm">=&gt;</span> <span class="n">1</span> <span class="s">}</span><span class="s">)</span> <span class="k">or</span>
    <span class="k">die</span> <span class="q">&quot;Cannot use CSV: &quot;</span> . <span class="w">Text::CSV_XS</span><span class="w">-&gt;error_diag</span><span class="s">(</span><span class="s">)</span><span class="sc">;</span>

<span class="c"># read</span>
<span class="k">open</span><span class="s">(</span><span class="k">my</span> <span class="i">$fh</span><span class="cm">,</span> <span class="q">&quot;&lt;:encoding(utf8)&quot;</span><span class="cm">,</span> <span class="q">&quot;test.csv&quot;</span><span class="s">)</span> <span class="k">or</span> <span class="k">die</span> <span class="q">&quot;test.csv: $!&quot;</span><span class="sc">;</span>
<span class="k">while</span> <span class="s">(</span><span class="k">my</span> <span class="i">$row</span> = <span class="i">$csv</span><span class="i">-&gt;getline</span><span class="s">(</span><span class="i">$fh</span><span class="s">)</span><span class="s">)</span> <span class="s">{</span>
    <span class="k">print</span> <span class="i">Dumper</span><span class="s">(</span>\<span class="i">$row</span><span class="s">)</span><span class="sc">;</span>
<span class="s">}</span>
<span class="i">$csv</span><span class="i">-&gt;eof</span> <span class="k">or</span> <span class="i">$csv</span><span class="i">-&gt;error_diag</span><span class="s">(</span><span class="s">)</span><span class="sc">;</span>
<span class="k">close</span><span class="s">(</span><span class="i">$fh</span><span class="s">)</span><span class="sc">;</span>

<span class="c"># read from string</span>
<span class="k">my</span> <span class="i">$line</span> = <span class="q">&quot;myid,filename,size as 9mb&quot;</span><span class="sc">;</span>
<span class="k">unless</span> <span class="s">(</span><span class="i">$csv</span><span class="i">-&gt;parse</span><span class="s">(</span><span class="i">$line</span><span class="s">)</span><span class="s">)</span> <span class="s">{</span>
    <span class="k">die</span> <span class="q">&quot;Failed to parse $line: &quot;</span> . <span class="i">$csv</span><span class="i">-&gt;error_diag</span><span class="s">(</span><span class="s">)</span> . <span class="q">&quot;\n&quot;</span><span class="sc">;</span>
<span class="s">}</span>
<span class="k">my</span> <span class="i">@field</span> = <span class="i">$csv</span><span class="i">-&gt;fields</span><span class="sc">;</span>
<span class="k">print</span> <span class="i">Dumper</span><span class="s">(</span>\<span class="i">@field</span><span class="s">)</span><span class="sc">;</span>

<span class="c"># print out to file</span>
<span class="i">$csv</span><span class="i">-&gt;print</span><span class="s">(</span><span class="i">$fh</span><span class="cm">,</span> <span class="s">[</span><span class="q">&#39;myid&#39;</span><span class="cm">,</span> <span class="q">&#39;filename&#39;</span><span class="cm">,</span> <span class="q">&#39;size as 9mb&#39;</span><span class="s">]</span><span class="s">)</span><span class="sc">;</span> <span class="k">print</span> <span class="i">$fh</span> <span class="q">&quot;\n&quot;</span><span class="sc">;</span>
<span class="c"># print out to STDOUT</span>
<span class="i">$csv</span><span class="i">-&gt;print</span><span class="s">(</span>\<span class="i">*STDOUT</span><span class="cm">,</span> \<span class="i">@rows</span><span class="s">)</span><span class="sc">;</span> <span class="k">print</span> <span class="q">&quot;\n&quot;</span><span class="sc">;</span>
</pre>

<p>如果有人非要找你要 xls 格式的话，你可以简单的用一下 <a href="http://cpansearch.perl.org/src/HMBRAND/Text-CSV_XS-0.85/examples/csv2xls">csv2xls</a> 来转成 xls 给他们。（如果连接失效，可 google "csv2xls cpan"）</p>
<p>但是如果他们需要一些特殊的 xls 功能的话，比如一些颜色，大小格式，或者 function 之类的，那我们就得求助于 <tt><a href="http://search.cpan.org/perldoc?Excel::Writer::XLSX" title="Excel::Writer::XLSX">Excel::Writer::XLSX</a></tt> 了。</p>
<p>该模块由 <tt><a href="http://search.cpan.org/perldoc?Spreadsheet::WriteExcel" title="Spreadsheet::WriteExcel">Spreadsheet::WriteExcel</a></tt> 的作者写的，相对 Spreadsheet::WriteExcel 提供了更好的性能和支持。</p>
<p>模块的使用也是非常简单的。（模块的使用都应该是很简单的，所有复杂的模块都是不合格的模块。:)</p>
<p>我们复制了 SYNOPSIS 过来。</p>
<pre>
<span class="k">use</span> <span class="w">Excel::Writer::XLSX</span><span class="sc">;</span>

<span class="c"># Create a new Excel workbook</span>
<span class="k">my</span> <span class="i">$workbook</span> = <span class="w">Excel::Writer::XLSX</span><span class="w">-&gt;new</span><span class="s">(</span> <span class="q">&#39;perl.xlsx&#39;</span> <span class="s">)</span><span class="sc">;</span>

<span class="c"># Add a worksheet</span>
<span class="i">$worksheet</span> = <span class="i">$workbook</span><span class="i">-&gt;add_worksheet</span><span class="s">(</span><span class="s">)</span><span class="sc">;</span>

<span class="c">#  Add and define a format</span>
<span class="i">$format</span> = <span class="i">$workbook</span><span class="i">-&gt;add_format</span><span class="s">(</span><span class="s">)</span><span class="sc">;</span>
<span class="i">$format</span><span class="i">-&gt;set_bold</span><span class="s">(</span><span class="s">)</span><span class="sc">;</span>
<span class="i">$format</span><span class="i">-&gt;set_color</span><span class="s">(</span> <span class="q">&#39;red&#39;</span> <span class="s">)</span><span class="sc">;</span>
<span class="i">$format</span><span class="i">-&gt;set_align</span><span class="s">(</span> <span class="q">&#39;center&#39;</span> <span class="s">)</span><span class="sc">;</span>

<span class="c"># Write a formatted and unformatted string, row and column notation.</span>
<span class="i">$col</span> = <span class="i">$row</span> = <span class="n">0</span><span class="sc">;</span>
<span class="i">$worksheet</span><span class="i">-&gt;write</span><span class="s">(</span> <span class="i">$row</span><span class="cm">,</span> <span class="i">$col</span><span class="cm">,</span> <span class="q">&#39;Hi Excel!&#39;</span><span class="cm">,</span> <span class="i">$format</span> <span class="s">)</span><span class="sc">;</span>
<span class="i">$worksheet</span><span class="i">-&gt;write</span><span class="s">(</span> <span class="n">1</span><span class="cm">,</span> <span class="i">$col</span><span class="cm">,</span> <span class="q">&#39;Hi Excel!&#39;</span> <span class="s">)</span><span class="sc">;</span>

<span class="c"># Write a number and a formula using A1 notation</span>
<span class="i">$worksheet</span><span class="i">-&gt;write</span><span class="s">(</span> <span class="q">&#39;A3&#39;</span><span class="cm">,</span> <span class="n">1.2345</span> <span class="s">)</span><span class="sc">;</span>
<span class="i">$worksheet</span><span class="i">-&gt;write</span><span class="s">(</span> <span class="q">&#39;A4&#39;</span><span class="cm">,</span> <span class="q">&#39;=SIN(PI()/4)&#39;</span> <span class="s">)</span><span class="sc">;</span>
</pre>

<p>2个模块都有非常详细的 EXAMPLES 目录。如果还是不会的话，可以来 PerlChina Group 发帖求助。</p>
<p>谢谢。</p>
<div style="float: right; font-size: 10pt"><a href="CSV_XLS.pod">View Source (POD)</a></div><br />
</body>
</html>
