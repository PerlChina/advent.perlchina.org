<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
   "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<!-- Generated by Pod::Advent 0.24 (Pod::Simple 3.07, Perl::Tidy 20101217) on 2011-12-09 04:28:02 -->
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<title>2011 Perl Advent Calendar: setuid perl</title>
<meta http-equiv="content-type" content="text/html; charset=utf-8" />
<link rel="stylesheet" href="../style.css" type="text/css" />
<link rel="alternate" type="text/plain" href="setuid.pod" />
</head>
<body>
<h1><a href="../">Perl Advent Calendar 2011-12</a>-09</h1>
<h2 align="center">setuid perl</h2>
<h3 align="center">by Joe Jiang</h3>
<p>SUID 是 Unix 的一个概念，可以让执行的程序拥有脚本的拥有者的权限。</p>
<pre>
    <span class="i">$ bin</span>/<span class="w">mysqlperl</span> -<span class="w">MEnglish</span> -<span class="k">le</span> <span class="q">&#39;print join qq(\t), $UID, $EUID&#39;</span>
    <span class="n">500</span>     <span class="n">27</span>

    <span class="i">$ id</span> <span class="w">mysql</span>
    <span class="w">uid</span>=<span class="n">27</span><span class="s">(</span><span class="w">mysql</span><span class="s">)</span> <span class="w">gid</span>=<span class="n">27</span><span class="s">(</span><span class="w">mysql</span><span class="s">)</span> <span class="w">groups</span>=<span class="n">27</span><span class="s">(</span><span class="w">mysql</span><span class="s">)</span>
</pre>

<p>这里的脚本程序 mysqlperl 其实就是 /usr/bin/perl 的一个拷贝，只不过能让 EUID 成为 mysql 用户而已。</p>
<p>$EUID 就是 Effective User ID 变量的缩写（由 English 模块引入别名），代表脚本执行时的实际权限。</p>
<p>这里的 mysql 用户可能有进一步的系统权限设定，比如能够不用密码登录数据库。</p>
<pre>
    <span class="w">mysql</span>&gt; <span class="w">GRANT</span> <span class="w">ALL</span> <span class="w">ON</span> <span class="w">rt</span>.<span class="i">* TO</span> <span class="w">mysql</span><span class="i">@localhost</span> <span class="w">identified</span> <span class="w">by</span> <span class="q">&#39;&#39;</span><span class="sc">;</span>
</pre>

<p>要实现这样的 bin/mysqlperl，只需要三步即可：</p>
<pre>
    <span class="i">$ cp</span> /<span class="w">usr</span>/<span class="w">bin</span>/<span class="w">perl</span> ~<span class="q">/bin/mysqlperl</span>

    <span class="i">$ sudo</span> <span class="k">chown</span> <span class="w">mysql</span><span class="co">:</span><span class="w">mysql</span> ~<span class="q">/bin/mysqlperl</span>

    <span class="i">$ sudo</span> <span class="k">chmod</span> <span class="w">u</span>+<span class="q">s ~/bin/mysqlperl</span>
</pre>

<p>作为验证，一个可选的步骤就是用 ls 查看这个可执行程序的 SUID 位。</p>
<pre>
    <span class="i">$ ls</span> -<span class="w">l</span> ~<span class="q">/bin/mysqlperl</span>
    -<span class="w">rwsr</span>-<span class="w">xr</span><span class="k">-x</span> <span class="n">1</span> <span class="w">mysql</span> <span class="w">mysql</span> <span class="n">8836</span> <span class="w">Dec</span>  <span class="n">4</span> <span class="n">15</span><span class="co">:</span><span class="n">36</span> <span class="w">bin</span>/<span class="w">mysqlperl</span>
</pre>

<p>希望你能小心使用这个技巧，注意藏好你的脚本解释器，最好不要轻易被系统管理员发现 :)</p>
<div style="float: right; font-size: 10pt"><a href="setuid.pod">View Source (POD)</a></div><br />
</body>
</html>
