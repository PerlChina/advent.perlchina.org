<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
   "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<!-- Generated by Pod::Advent 0.24 (Pod::Simple 3.13, Perl::Tidy 20101217) on 2011-12-12 17:27:22 -->
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<title>2011 Perl Advent Calendar: GraphViz::DBI::mysql</title>
<meta http-equiv="content-type" content="text/html; charset=utf-8" />
<link rel="stylesheet" href="../style.css" type="text/css" />
<link rel="alternate" type="text/plain" href="db-layout-graphviz.pod" />
</head>
<body>
<h1><a href="../">Perl Advent Calendar 2011-12</a>-11</h1>
<h2 align="center">GraphViz::DBI::mysql</h2>
<h3 align="center">by Joe Jiang</h3>
<p>其实这还不是一个真正可用的模块，这里的名字只是预备将来发布的，所以请各位看官大家 手下留情，先不要注册掉它。</p>
<p>GraphViz::DBI 是一个基于 GraphViz 的模块，目标是用来进行数据库 ER 图的绘制，可以 输出的格式非常多，这里用 PNG 格式来举例。</p>
<p>要使用这个模块，首先要有一个可用的数据库 DBI 连接。然后要覆盖这个模块的外键参考依赖子程序，这样才能从特定数据库获取元数据。最后，还要用这个修正过的模块来输出图 片。</p>
<p>这里的 MySQL 数据库使用了样本数据库 employees，可以在网上下载 https://launchpad.net/test-db/employees-db-1。这里假定样本数据库已经创建并导入，并且用 DBI 登录 MySQL 的问题已经解决。</p>
<p>第一步，启动 Perl 调试器（perl -de 0），载入并修正 GraphViz::DBI：</p>
<pre>
<a name="GraphViz::DBI::is_foreign_key"></a>  <span class="w">DB</span><span class="q">&lt;1&gt;</span> <span class="k">use</span> <span class="w">GraphViz::DBI</span><span class="sc">;</span> <span class="k">sub </span><span class="m">GraphViz::DBI::is_foreign_key</span> <span class="s">{</span> <span class="k">return</span> <span class="q">qq(`employees`.`$_-&gt;{REFERENCED_TABLE_NAME}`)</span> <span class="k">for</span> <span class="i">@</span>{<span class="i">$_</span>[<span class="n">0</span>]-&gt;{<span class="w">dbh</span>}<span class="i">-&gt;selectall_arrayref</span><span class="s">(</span><span class="q">q{select REFERENCED_TABLE_NAME, REFERENCED_COLUMN_NAME from information_schema.key_column_usage where REFERENCED_COLUMN_NAME=? and COLUMN_NAME=? and TABLE_SCHEMA=? and TABLE_NAME=?}</span><span class="cm">,</span> <span class="s">{</span><span class="w">Slice</span> <span class="cm">=&gt;</span> <span class="s">{</span><span class="s">}</span><span class="s">}</span><span class="cm">,</span> <span class="i">$_</span>[<span class="n">2</span>]<span class="cm">,</span> <span class="i">$_</span>[<span class="n">2</span>]<span class="cm">,</span> <span class="i">$_</span>[<span class="n">1</span>]=~<span class="q">m{(\w+)\W+(\w+)}</span><span class="s">)</span>} <span class="s">}</span>
</pre>

<p>这里通过查询了 MySQL 的元数据 information_schema.key_column_usage，从其中查找某个表的字段是否有参考的主表，若查询结果不为空的话，就返回表名作为结果，否则返回空 。</p>
<p>第二步，创建数据库连接，这里要求用户能够不用密码登录，且获得了查询 information_schema 的权限：</p>
<pre>
  <span class="w">DB</span><span class="q">&lt;2&gt;</span> <span class="k">use</span> <span class="w">DBI</span><span class="sc">;</span> <span class="i">$d</span>=<span class="w">DBI</span><span class="w">-&gt;connect</span><span class="s">(</span><span class="q">q(DBI:mysql:database=employees)</span><span class="cm">,</span> <span class="q">q()</span><span class="cm">,</span> <span class="q">q()</span><span class="s">)</span>
</pre>

<p>第三步，命名临时文件，并正式驱动模块生成图片：</p>
<pre>
  <span class="w">DB</span><span class="q">&lt;3&gt;</span> x <span class="k">open</span> <span class="w">F</span><span class="cm">,</span> <span class="q">q(&gt;)</span><span class="cm">,</span> <span class="q">q(tmp.1sKZjd1d4L.png)</span><span class="sc">;</span> <span class="k">print</span> <span class="i">F</span> <span class="w">GraphViz::DBI</span><span class="w">-&gt;new</span><span class="s">(</span><span class="i">$d</span><span class="s">)</span><span class="i">-&gt;graph_tables</span><span class="i">-&gt;as_png</span>
</pre>

<p>欢迎尝试其他数据库，效果应该还不错 :)</p>
<p><img src='db-layout-graphviz.png' border='0' /></p>
<div style="float: right; font-size: 10pt"><a href="db-layout-graphviz.pod">View Source (POD)</a></div><br />
</body>
</html>
