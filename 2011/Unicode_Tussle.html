<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
   "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<!-- Generated by Pod::Advent 0.24 (Pod::Simple 3.14, Perl::Tidy 20101217) on 2011-12-20 20:29:15 -->
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<title>2011 Perl Advent Calendar: BerkeleyDB</title>
<meta http-equiv="content-type" content="text/html; charset=utf-8" />
<link rel="stylesheet" href="../style.css" type="text/css" />
<link rel="alternate" type="text/plain" href="Unicode_Tussle.pod" />
</head>
<body>
<h1><a href="../">Perl Advent Calendar 2011-12</a>-06</h1>
<h2 align="center">BerkeleyDB</h2>
<h3 align="center">by Fayland Lam</h3>
<p><tt><a href="http://search.cpan.org/perldoc?BerkeleyDB" title="BerkeleyDB">BerkeleyDB</a></tt> 是个高性能的数据库。</p>
<p>当您需要操作一个极其巨大的文件，需要构造一个 super big 的 hash 或者 array 的时候，内存可能就是您最大的烦恼所在。而 BerkeleyDB 可以通过硬盘空间来保存该 hash 或者 array，到时候可以快速定位和 sort 之类，来完成您的需求。</p>
<p>BerkeleyDB 的详细介绍和设计可以参阅 <a href="http://www.aosabook.org/en/bdb.html">The Architecture of Open Source Applications</a> 的章节。</p>
<p>在 Ubuntu 之类的系统下可以通过 $ sudo apt-get install libberkeleydb-perl 来安装，FreeBSD 可以到 /usr/ports/databases/p5-BerkeleyDB 来 make install, Win32 下不支持，其它的可以 Google 得到安装指南。</p>
<p>在单线程的情况下，一个简单的例子如下：</p>
<pre>
<span class="k">use</span> <span class="w">FindBin</span> <span class="q">qw/$Bin/</span><span class="sc">;</span>
<span class="k">use</span> <span class="w">BerkeleyDB</span><span class="sc">;</span>

<span class="k">my</span> <span class="i">$berkeleydb_temp_file</span> = <span class="q">&quot;$Bin/tmp.berkeleydb&quot;</span><span class="sc">;</span> <span class="c"># temp file for BerkeleyDB</span>
<span class="k">tie</span> <span class="k">my</span> <span class="i">%data</span><span class="cm">,</span> <span class="q">&#39;BerkeleyDB::Hash&#39;</span><span class="cm">,</span>
    -<span class="w">Filename</span> <span class="cm">=&gt;</span> <span class="i">$berkeleydb_temp_file</span><span class="cm">,</span>
    -<span class="w">Flags</span>    <span class="cm">=&gt;</span> <span class="w">DB_CREATE</span>|<span class="w">DB_TRUNCATE</span>
        <span class="k">or</span> <span class="k">die</span> <span class="q">&quot;Cannot create file: $! $BerkeleyDB::Error\n&quot;</span><span class="sc">;</span>
<span class="k">open</span><span class="s">(</span><span class="k">my</span> <span class="i">$fh</span><span class="cm">,</span> <span class="q">&#39;&lt;&#39;</span><span class="cm">,</span> <span class="q">&#39;RealBigFile.log&#39;</span><span class="s">)</span> <span class="k">or</span> <span class="k">die</span> <span class="q">&quot;Can&#39;t open: $!&quot;</span><span class="sc">;</span>
<span class="k">while</span> <span class="s">(</span><span class="k">my</span> <span class="i">$line</span> = <span class="q">&lt;$fh&gt;</span><span class="s">)</span> <span class="s">{</span>
    <span class="c">## some code that %data will be a real very big hash</span>
    <span class="c">## we just need the first line and the last line which matches the $pattern</span>
    <span class="k">my</span> <span class="i">$pattern</span> = <span class="i">get_pattern</span><span class="s">(</span><span class="i">$line</span><span class="s">)</span><span class="sc">;</span>
    <span class="k">if</span> <span class="s">(</span><span class="k">exists</span> <span class="i">$data</span>{<span class="q">&quot;start_$pattern&quot;</span>}<span class="s">)</span> <span class="s">{</span>
        <span class="i">$data</span>{<span class="q">&quot;end_$pattern&quot;</span>} = <span class="i">$line</span><span class="sc">;</span>
    <span class="s">}</span> <span class="k">else</span> <span class="s">{</span>
        <span class="i">$data</span>{<span class="q">&quot;start_$pattern&quot;</span>} = <span class="i">$line</span><span class="sc">;</span>
    <span class="s">}</span>
<span class="s">}</span>
<span class="k">close</span><span class="s">(</span><span class="i">$fh</span><span class="s">)</span><span class="sc">;</span>
<span class="c"># now working on the %data</span>
</pre>

<p>你可以不停的 ls -ls 来查看 tmp.berkeleydb 的大小，顺便 monitor 下内存。</p>
<p>BerkeleyDB 对多线程的支持也很不错，支持数千并发线程，最大 256TB 数据。在多线程的情况下，需要使用 BerkeleyDB::Env cds_lock 保证数据安全。简单的例子如下：</p>
<pre>
<span class="k">my</span> <span class="i">$env</span> = <span class="w">new</span> <span class="w">BerkeleyDB::Env</span>
    -<span class="w">Home</span>   <span class="cm">=&gt;</span> <span class="i">$tmp_dir</span><span class="cm">,</span>
    -<span class="w">Flags</span>  <span class="cm">=&gt;</span> <span class="w">DB_CREATE</span>|<span class="w">DB_INIT_CDB</span>|<span class="w">DB_INIT_MPOOL</span>
        <span class="k">or</span> <span class="k">die</span> <span class="q">&quot;cannot open environment: $BerkeleyDB::Error\n&quot;</span><span class="sc">;</span>
<span class="k">my</span> <span class="i">$db</span> = <span class="k">tie</span> <span class="k">my</span> <span class="i">%data</span><span class="cm">,</span> <span class="q">&#39;BerkeleyDB::Hash&#39;</span><span class="cm">,</span>
    -<span class="w">Filename</span> <span class="cm">=&gt;</span> <span class="i">$berkeleydb_temp_file</span><span class="cm">,</span>
    -<span class="w">Flags</span>    <span class="cm">=&gt;</span> <span class="w">DB_CREATE</span><span class="cm">,</span>
    -<span class="w">Env</span>      <span class="cm">=&gt;</span> <span class="i">$env</span>
        <span class="k">or</span> <span class="k">die</span> <span class="q">&quot;Cannot create file: $! $BerkeleyDB::Error\n&quot;</span><span class="sc">;</span>

<span class="k">my</span> <span class="i">$pm</span> = <span class="w">new</span> <span class="i">Parallel::ForkManager</span><span class="s">(</span><span class="n">4</span><span class="s">)</span><span class="sc">;</span>
<span class="k">foreach</span> <span class="k">my</span> <span class="i">$i</span> <span class="s">(</span><span class="n">1</span> .. <span class="n">1000</span><span class="s">)</span> <span class="s">{</span>
    <span class="i">$pm</span><span class="i">-&gt;start</span> <span class="k">and</span> <span class="k">next</span><span class="sc">;</span> <span class="c"># do the fork</span>

    <span class="k">my</span> <span class="i">$lock</span> = <span class="i">$db</span><span class="i">-&gt;cds_lock</span><span class="s">(</span><span class="s">)</span><span class="sc">;</span>
    <span class="i">$data</span>{<span class="i">$i</span>} = <span class="i">$i</span> * <span class="n">2</span><span class="sc">;</span>
    <span class="i">$db</span><span class="i">-&gt;db_sync</span><span class="s">(</span><span class="s">)</span><span class="sc">;</span>
    <span class="i">$lock</span><span class="i">-&gt;cds_unlock</span><span class="s">(</span><span class="s">)</span><span class="sc">;</span>
    
    <span class="i">$pm</span><span class="i">-&gt;finish</span><span class="sc">;</span> <span class="c"># Terminates the child process</span>
<span class="s">}</span>


<span class="i">$pm</span><span class="i">-&gt;wait_all_children</span><span class="sc">;</span>
</pre>

<p>更多的使用方法请参阅 perldoc <tt><span title="BerkeleyDB">BerkeleyDB</span></tt>。</p>
<p>谢谢。</p>
<div style="float: right; font-size: 10pt"><a href="Unicode_Tussle.pod">View Source (POD)</a></div><br />
</body>
</html>
